<!DOCTYPE html>
<html lang="ca">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>Mapa 3D AR - Punts d'Interès</title>
    <style>
        body {
            margin: 0;
            padding: 0;
            font-family: Arial, sans-serif;
            overflow: hidden;
            background-color: #000;
            color: white;
        }
        
        #container {
            position: relative;
            width: 100vw;
            height: 100vh;
        }
        
        #arView {
            width: 100%;
            height: 100%;
            display: block;
        }
        
        #infoPanel {
            position: absolute;
            top: 10px;
            left: 10px;
            background-color: rgba(0, 0, 0, 0.7);
            padding: 10px;
            border-radius: 5px;
            z-index: 100;
        }
        
        #compass {
            position: absolute;
            top: 10px;
            right: 10px;
            width: 60px;
            height: 60px;
            background-color: rgba(0, 0, 0, 0.7);
            border-radius: 50%;
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 100;
        }
        
        #compassArrow {
            width: 30px;
            height: 30px;
            background-image: url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="red"><path d="M12 2L4 12l8 10 8-10z"/></svg>');
            background-size: contain;
            background-repeat: no-repeat;
            transition: transform 0.1s ease-out;
        }
        
        #pointsList {
            position: absolute;
            bottom: 10px;
            left: 10px;
            background-color: rgba(0, 0, 0, 0.7);
            padding: 10px;
            border-radius: 5px;
            max-height: 150px;
            overflow-y: auto;
            z-index: 100;
        }
        
        .pointItem {
            margin: 5px 0;
            cursor: pointer;
        }
        
        .pointItem:hover {
            color: #4CAF50;
        }
        
        #loading {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            font-size: 1.5em;
            z-index: 200;
        }
    </style>
</head>
<body>
    <div id="container">
        <canvas id="arView"></canvas>
        
        <div id="infoPanel">
            <div>Latitud: <span id="latitude">--</span></div>
            <div>Longitud: <span id="longitude">--</span></div>
            <div>Altitud: <span id="altitude">--</span> msnm</div>
            <div>Precisió: <span id="accuracy">--</span> m</div>
            <div>Direcció: <span id="heading">--</span>°</div>
        </div>
        
        <div id="compass">
            <div id="compassArrow"></div>
        </div>
        
        <div id="pointsList">
            <h3>Punts d'Interès:</h3>
            <div class="pointItem" data-id="1">Esglèsia (412 msnm)</div>
            <div class="pointItem" data-id="2">Ermita (560 msnm)</div>
            <div class="pointItem" data-id="3">Sant Bernat (456 msnm)</div>
            <div class="pointItem" data-id="4">Roca de la Manxa (499 msnm)</div>
        </div>
        
        <div id="loading">Carregant...</div>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/three@0.128.0/examples/js/controls/OrbitControls.min.js"></script>
    <script src="https://unpkg.com/three@0.128.0/examples/js/loaders/GLTFLoader.js"></script>
    
    <script>
        // Punts d'interès definits
        const pointsOfInterest = [
            { id: 1, name: "Esglèsia", lat: 41.396712, lon: 1.103376, alt: 412, color: 0xFF0000 },
            { id: 2, name: "Ermita", lat: 41.3731, lon: 1.11065, alt: 560, color: 0x00FF00 },
            { id: 3, name: "Sant Bernat", lat: 41.388193, lon: 1.083005, alt: 456, color: 0x0000FF },
            { id: 4, name: "Roca de la Manxa", lat: 41.426297, lon: 1.115281, alt: 499, color: 0xFFFF00 }
        ];

        // Variables globals
        let scene, camera, renderer, controls;
        let userPosition = { lat: 0, lon: 0, alt: 0, accuracy: 0 };
        let userHeading = 0;
        let poiMarkers = [];
        let compassArrow = document.getElementById('compassArrow');
        let watchId;
        
        // Inicialització de l'aplicació
        function init() {
            setup3DScene();
            setupEventListeners();
            requestGeolocation();
        }
        
        // Configuració de l'escena 3D
        function setup3DScene() {
            // Escena
            scene = new THREE.Scene();
            scene.background = new THREE.Color(0x000000);
            
            // Càmera
            camera = new THREE.PerspectiveCamera(75, window.innerWidth / window.innerHeight, 0.1, 1000);
            camera.position.set(0, 1.6, 0);
            
            // Renderer
            renderer = new THREE.WebGLRenderer({ canvas: document.getElementById('arView'), antialias: true });
            renderer.setSize(window.innerWidth, window.innerHeight);
            renderer.setPixelRatio(window.devicePixelRatio);
            
            // Controls (per a proves en escriptori)
            controls = new THREE.OrbitControls(camera, renderer.domElement);
            controls.enableZoom = true;
            controls.enablePan = false;
            controls.enableDamping = true;
            controls.dampingFactor = 0.25;
            
            // Llum ambiental
            const ambientLight = new THREE.AmbientLight(0x404040);
            scene.add(ambientLight);
            
            // Llum direccional
            const directionalLight = new THREE.DirectionalLight(0xffffff, 0.5);
            directionalLight.position.set(1, 1, 1);
            scene.add(directionalLight);
            
            // Afegir marcadors pels punts d'interès (inicialment invisibles)
            pointsOfInterest.forEach(point => {
                const markerGeometry = new THREE.SphereGeometry(0.05, 16, 16);
                const markerMaterial = new THREE.MeshBasicMaterial({ color: point.color });
                const marker = new THREE.Mesh(markerGeometry, markerMaterial);
                marker.visible = false;
                marker.userData = point;
                scene.add(marker);
                poiMarkers.push(marker);
                
                // Afegir etiqueta de text (simplificat)
                const label = document.createElement('div');
                label.textContent = point.name;
                label.style.position = 'absolute';
                label.style.color = `rgb(${Math.floor(point.color.r * 255)}, ${Math.floor(point.color.g * 255)}, ${Math.floor(point.color.b * 255)})`;
                label.style.fontSize = '12px';
                label.style.pointerEvents = 'none';
                document.body.appendChild(label);
                marker.userData.label = label;
            });
            
            // Animació
            animate();
        }
        
        // Sol·licitar geolocalització
        function requestGeolocation() {
            if (navigator.geolocation) {
                // Obtenir posició inicial
                navigator.geolocation.getCurrentPosition(
                    position => updatePosition(position),
                    error => console.error('Error de geolocalització:', error),
                    { enableHighAccuracy: true, maximumAge: 0 }
                );
                
                // Configurar actualització contínua
                watchId = navigator.geolocation.watchPosition(
                    position => updatePosition(position),
                    error => console.error('Error de geolocalització:', error),
                    { enableHighAccuracy: true, maximumAge: 0, timeout: 5000 }
                );
            } else {
                alert('Geolocalització no és compatible amb aquest navegador');
            }
        }
        
        // Actualitzar posició de l'usuari
        function updatePosition(position) {
            userPosition = {
                lat: position.coords.latitude,
                lon: position.coords.longitude,
                alt: position.coords.altitude || 0,
                accuracy: position.coords.accuracy
            };
            
            // Actualitzar UI
            document.getElementById('latitude').textContent = userPosition.lat.toFixed(6);
            document.getElementById('longitude').textContent = userPosition.lon.toFixed(6);
            document.getElementById('altitude').textContent = Math.round(userPosition.alt);
            document.getElementById('accuracy').textContent = Math.round(userPosition.accuracy);
            
            // Actualitzar heading si està disponible
            if (position.coords.heading !== null && !isNaN(position.coords.heading)) {
                userHeading = position.coords.heading;
                document.getElementById('heading').textContent = Math.round(userHeading);
                updateCompass();
            }
            
            // Actualitzar marcadors dels punts d'interès
            updatePOIMarkers();
            
            // Amagar missatge de carregament un cop tenim dades
            document.getElementById('loading').style.display = 'none';
        }
        
        // Actualitzar brúixola
        function updateCompass() {
            compassArrow.style.transform = `rotate(${360 - userHeading}deg)`;
        }
        
        // Actualitzar marcadors dels punts d'interès
        function updatePOIMarkers() {
            poiMarkers.forEach(marker => {
                const poi = marker.userData;
                
                // Calcular distància i direcció respecte a l'usuari
                const distance = calculateDistance(
                    userPosition.lat, userPosition.lon, 
                    poi.lat, poi.lon
                );
                
                const bearing = calculateBearing(
                    userPosition.lat, userPosition.lon, 
                    poi.lat, poi.lon
                );
                
                // Convertir a coordenades 3D (simplificat)
                const relativeBearing = (bearing - userHeading + 360) % 360;
                const angle = THREE.MathUtils.degToRad(relativeBearing);
                
                // Distància i alçada relativa
                const x = Math.sin(angle) * (distance / 1000);
                const z = Math.cos(angle) * (distance / 1000);
                const y = (poi.alt - userPosition.alt) / 1000;
                
                // Actualitzar posició del marcador
                marker.position.set(x, y, z);
                marker.visible = true;
                
                // Actualitzar etiqueta (posició simplificada)
                const screenPos = new THREE.Vector3(x, y, z);
                screenPos.project(camera);
                
                const label = marker.userData.label;
                label.style.left = `${(screenPos.x * 0.5 + 0.5) * window.innerWidth}px`;
                label.style.top = `${(-(screenPos.y * 0.5) + 0.5) * window.innerHeight}px`;
                label.style.display = screenPos.z > 1 ? 'none' : 'block';
            });
        }
        
        // Càlcul de distància entre dos punts (fórmula Haversine)
        function calculateDistance(lat1, lon1, lat2, lon2) {
            const R = 6371000; // Radi de la Terra en metres
            const φ1 = lat1 * Math.PI/180;
            const φ2 = lat2 * Math.PI/180;
            const Δφ = (lat2-lat1) * Math.PI/180;
            const Δλ = (lon2-lon1) * Math.PI/180;
            
            const a = Math.sin(Δφ/2) * Math.sin(Δφ/2) +
                      Math.cos(φ1) * Math.cos(φ2) *
                      Math.sin(Δλ/2) * Math.sin(Δλ/2);
            const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
            
            return R * c;
        }
        
        // Càlcul de direcció (bearing) entre dos punts
        function calculateBearing(lat1, lon1, lat2, lon2) {
            const φ1 = lat1 * Math.PI/180;
            const φ2 = lat2 * Math.PI/180;
            const λ1 = lon1 * Math.PI/180;
            const λ2 = lon2 * Math.PI/180;
            
            const y = Math.sin(λ2-λ1) * Math.cos(φ2);
            const x = Math.cos(φ1)*Math.sin(φ2) -
                      Math.sin(φ1)*Math.cos(φ2)*Math.cos(λ2-λ1);
            const θ = Math.atan2(y, x);
            
            return (θ*180/Math.PI + 360) % 360;
        }
        
        // Configurar listeners d'esdeveniments
        function setupEventListeners() {
            window.addEventListener('resize', onWindowResize);
            
            // Listeners per als punts d'interès
            document.querySelectorAll('.pointItem').forEach(item => {
                item.addEventListener('click', () => {
                    const id = parseInt(item.getAttribute('data-id'));
                    const poi = pointsOfInterest.find(p => p.id === id);
                    if (poi) {
                        alert(`Punt seleccionat: ${poi.name}\nLatitud: ${poi.lat}\nLongitud: ${poi.lon}\nAltitud: ${poi.alt} msnm`);
                    }
                });
            });
            
            // Simulació de brúixola per a proves en escriptori
            if (!window.DeviceOrientationEvent) {
                console.log("Dispositiu no compatible amb l'API DeviceOrientation");
                document.addEventListener('keydown', (e) => {
                    if (e.key === 'ArrowLeft') {
                        userHeading = (userHeading + 5) % 360;
                        updateCompass();
                        updatePOIMarkers();
                    } else if (e.key === 'ArrowRight') {
                        userHeading = (userHeading - 5 + 360) % 360;
                        updateCompass();
                        updatePOIMarkers();
                    }
                });
            } else {
                window.addEventListener('deviceorientation', (event) => {
                    if (event.absolute && event.alpha !== null) {
                        userHeading = event.alpha;
                        updateCompass();
                        updatePOIMarkers();
                    }
                });
            }
        }
        
        // Gestionar redimensionament de la finestra
        function onWindowResize() {
            camera.aspect = window.innerWidth / window.innerHeight;
            camera.updateProjectionMatrix();
            renderer.setSize(window.innerWidth, window.innerHeight);
        }
        
        // Bucle d'animació
        function animate() {
            requestAnimationFrame(animate);
            controls.update();
            renderer.render(scene, camera);
        }
        
        // Iniciar l'aplicació quan es carrega la pàgina
        window.addEventListener('load', init);
    </script>
</body>
</html>
