<!DOCTYPE html>
<html>
<head>
    <title>Comparador Preus ...</title>
    <script src="https://cdn.jsdelivr.net/npm/pyscript@2024.7.1"></script>
    <py-config>
        packages = ["requests", "beautifulsoup4", "lxml", "pandas"]
    </py-config>
    <style>
        table { border-collapse: collapse; width: 100%; margin: 20px 0; }
        th, td { border: 1px solid #ddd; padding: 12px; text-align: left; }
        th { background-color: #f2f2f2; }
        .millor { background-color: #d4edda; font-weight: bold; color: green; }
    </style>
</head>
<body>
    <h1>üîç Comparador de Preus - Aigua Font Vella</h1>
    <p><em>--- Actualitzant preus... (pot trigar uns segons)</em></p>
    
    <table id="preus-table">
        <thead>
            <tr>
                <th>Producte</th>
                <th>Condis (‚Ç¨)</th>
                <th>Bon√†rea (‚Ç¨)</th>
                <th>üü¢ Millor Preu</th>
            </tr>
        </thead>
        <tbody id="taula-body">
            <tr><td colspan="4">Carregant...</td></tr>
        </tbody>
    </table>

    <py-script>
import asyncio
import json
from bs4 import BeautifulSoup
from pyweb_io import document
from js import fetch
import re

async def scrape_condis(url):
    """Scraping Condis - cal inspeccionar selectors reals"""
    try:
        response = await fetch(url)
        text = await response.text()
        soup = BeautifulSoup(text, 'lxml')
        
        # SELECTORS PROVISIONALS - INSPECCIONA LA WEB!
        preu_elem = soup.select_one('[class*="price"], [class*="Price"], .precio')
        nom_elem = soup.select_one('[class*="product"], [class*="Product"], h1, h2')
        
        preu = preu_elem.text.strip() if preu_elem else "N/D"
        nom = nom_elem.text.strip() if nom_elem else "Aigua Font Vella"
        
        # Neteja preu (exemple)
        preu_net = re.sub(r'[^\d.,]', '', preu)
        preu_float = float(preu_net.replace(',', '.')) if preu_net != "N/D" else None
        
        return {'nom': nom[:50], 'preu': preu_float, 'preu_text': preu}
    except Exception as e:
        return {'nom': 'Error Condis', 'preu': None, 'preu_text': 'N/D'}

async def scrape_bonarea(url):
    """Scraping Bon√†rea"""
    try:
        response = await fetch(url)
        text = await response.text()
        soup = BeautifulSoup(text, 'lxml')
        
        # SELECTORS PROVISIONALS - INSPECCIONA LA WEB!
        preu_elem = soup.select_one('[itemprop="price"], .price, [class*="precio"]')
        nom_elem = soup.select_one('[itemprop="name"], .product-title, h1')
        
        preu = preu_elem.get('content') or preu_elem.text.strip() if preu_elem else "N/D"
        nom = nom_elem.text.strip() if nom_elem else "Aigua Font Vella Garrafa"
        
        preu_net = re.sub(r'[^\d.,‚Ç¨]', '', preu)
        preu_float = float(preu_net.replace(',', '.').replace('‚Ç¨', '')) if preu_net != "N/D" else None
        
        return {'nom': nom[:50], 'preu': preu_float, 'preu_text': preu}
    except Exception as e:
        return {'nom': 'Error Bon√†rea', 'preu': None, 'preu_text': 'N/D'}

# Execuci√≥ principal
async def main():
    condis_url = "https://compraonline.condis.es/bebidas_aguas-y-gaseosas/c/c07__cat00280001/es_ES"
    bonarea_url = "https://www.bonarea-online.com/online/producto/agua-mineral-font-vella-garrafa/13_0086895"
    
    print("üîÑ Carregant dades...")
    
    condis_data, bonarea_data = await asyncio.gather(
        scrape_condis(condis_url),
        scrape_bonarea(bonarea_url)
    )
    
    # Troba millor preu
    preus = [d['preu'] for d in [condis_data, bonarea_data] if d['preu']]
    millor_preu = min(preus) if preus else None
    millor_text = f"{min(preus):.2f}‚Ç¨" if millor_preu else "Empat/N/D"
    
    # Genera fila de taula
    tbody = document.getElementById("taula-body")
    html_row = f"""
    <tr>
        <td>{condis_data['nom']}</td>
        <td>{condis_data['preu_text'] or 'N/D'}</td>
        <td>{bonarea_data['preu_text'] or 'N/D'}</td>
        <td class="millor">{millor_text}</td>
    </tr>
    """
    tbody.innerHTML = html_row
    
    print("‚úÖ Dades actualitzades!")

# Executa
await main()
    </py-script>
</body>
</html>


