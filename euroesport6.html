<!DOCTYPE html>
<html lang="ca">
<head>
    <meta charset="UTF-8">
    <title>Reproductor Multicanal Automàtic</title>
    <style>
        body {
            margin: 0;
            padding: 20px;
            background: #1a1a1a;
            color: white;
            font-family: Arial, sans-serif;
            height: 100vh;
            display: flex;
            flex-direction: column;
        }

        #mainContainer {
            display: flex;
            flex: 1;
            gap: 20px;
            margin-top: 20px;
        }

        #videoSection {
            flex: 3;
            min-width: 700px;
        }

        #channelHeader {
            display: flex;
            align-items: center;
            margin-bottom: 15px;
            padding: 10px;
            background: #2a2a2a;
            border-radius: 8px;
        }

        #channelLogo {
            width: 60px;
            height: 60px;
            margin-right: 15px;
            object-fit: contain;
        }

        #channelTitle {
            font-size: 1.5em;
            font-weight: bold;
        }

        #videoPlayer {
            width: 100%;
            height: 500px;
            background: black;
            border-radius: 8px;
        }

        #controlsSection {
            margin-top: 20px;
            background: #2a2a2a;
            padding: 15px;
            border-radius: 8px;
        }

        .track-group {
            margin-bottom: 15px;
        }

        .track-group h3 {
            color: #007bff;
            margin: 0 0 10px 0;
        }

        .track-btn {
            padding: 8px 15px;
            margin: 5px;
            background: #333;
            color: white;
            border: none;
            border-radius: 20px;
            cursor: pointer;
            transition: all 0.3s;
        }

        .track-btn.active {
            background: #007bff;
            transform: scale(1.05);
        }

        #channelsPanel {
            flex: 1;
            background: #2a2a2a;
            border-radius: 8px;
            padding: 15px;
            max-height: 80vh;
            overflow-y: auto;
        }

        .channel-btn {
            display: flex;
            align-items: center;
            width: 100%;
            padding: 12px;
            margin: 8px 0;
            background: #333;
            border: none;
            color: white;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s;
        }

        .channel-btn.active {
            background: #007bff;
            transform: translateX(10px);
        }

        .channel-btn img {
            width: 40px;
            height: 40px;
            margin-right: 15px;
            border-radius: 6px;
            object-fit: cover;
        }

        #loadSection {
            margin-bottom: 20px;
            display: flex;
            gap: 10px;
        }

        #m3uUrl {
            flex: 1;
            padding: 10px;
            border-radius: 6px;
            border: 1px solid #444;
            background: #333;
            color: white;
        }

        #loadBtn {
            padding: 10px 20px;
            background: #007bff;
            color: white;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            transition: background 0.3s;
        }

        #loadBtn:hover {
            background: #0056b3;
        }

        .error {
            color: #ff4444;
            padding: 10px;
            margin-top: 10px;
            background: #330000;
            border-radius: 6px;
            display: none;
        }
    </style>
</head>
<body>
    <div id="loadSection">
        <input type="url" id="m3uUrl" placeholder="Introdueix URL de llista M3U..." value="https://xarxa-1.github.io/Xarxa-1/cat19.m3u">
        <button id="loadBtn" onclick="loadPlaylist()">Carrega Canals</button>
    </div>
    <div class="error" id="errorMessage"></div>

    <div id="mainContainer">
        <div id="videoSection">
            <div id="channelHeader">
                <img id="channelLogo" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAQAAAC1HAwCAAAAC0lEQVR42mNkYAAAAAYAAjCB0C8AAAAASUVORK5CYII=" alt="Logo">
                <div id="channelTitle">Selecciona un canal</div>
            </div>
            <video id="videoPlayer" controls crossorigin="anonymous"></video>
            
            <div id="controlsSection">
                <div class="track-group">
                    <h3>Pistes d'Àudio</h3>
                    <div id="audioTracks"></div>
                </div>
                <div class="track-group">
                    <h3>Subtítols</h3>
                    <div id="subtitleTracks"></div>
                </div>
            </div>
        </div>

        <div id="channelsPanel"></div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/hls.js@latest"></script>
    <script>
        let currentHls = null;
        let currentChannel = null;

        async function loadPlaylist() {
            const m3uUrl = document.getElementById('m3uUrl').value;
            const panel = document.getElementById('channelsPanel');
            panel.innerHTML = '<div>Carregant canals...</div>';
            
            try {
                const response = await fetch(m3uUrl);
                const m3uContent = await response.text();
                const channels = parseM3U(m3uContent);
                renderChannels(channels);
                // Reproduir automàticament el primer canal
                if(channels.length > 0) {
                    const firstChannel = panel.querySelector('.channel-btn');
                    if(firstChannel) firstChannel.click();
                }
            } catch (error) {
                showError(`Error carregant llista: ${error.message}`);
            }
        }

        function parseM3U(content) {
            const channels = [];
            const lines = content.split('\n');
            
            for(let i = 0; i < lines.length; i++) {
                if(lines[i].startsWith('#EXTINF:-1')) {
                    const channel = {
                        name: lines[i].split(/,(.*)/)[1]?.trim() || 'Canal Desconegut',
                        logo: lines[i].match(/tvg-logo="(.*?)"/)?.[1] || '',
                        url: lines[i+1]?.trim()
                    };
                    if(channel.url) channels.push(channel);
                }
            }
            return channels;
        }

        function renderChannels(channels) {
            const panel = document.getElementById('channelsPanel');
            panel.innerHTML = '';
            
            channels.forEach(channel => {
                const btn = document.createElement('button');
                btn.className = 'channel-btn';
                btn.innerHTML = `
                    ${channel.logo ? `<img src="${channel.logo}" alt="${channel.name}">` : ''}
                    <span>${channel.name}</span>
                `;
                
                btn.onclick = () => {
                    if(currentChannel) currentChannel.classList.remove('active');
                    currentChannel = btn;
                    btn.classList.add('active');
                    updateChannelHeader(channel);
                    playChannel(channel);
                };
                
                panel.appendChild(btn);
            });
        }

        function updateChannelHeader(channel) {
            const logoElement = document.getElementById('channelLogo');
            const titleElement = document.getElementById('channelTitle');
            
            if(channel.logo) {
                logoElement.src = channel.logo;
                logoElement.style.display = 'block';
            } else {
                logoElement.style.display = 'none';
            }
            
            titleElement.textContent = channel.name;
        }

        function playChannel(channel) {
            if(currentHls) {
                currentHls.destroy();
                document.getElementById('audioTracks').innerHTML = '';
                document.getElementById('subtitleTracks').innerHTML = '';
            }
            
            const video = document.getElementById('videoPlayer');
            currentHls = new Hls({ 
                enableWebVTT: true,
                manifestLoadingTimeOut: 10000
            });
            
            currentHls.loadSource(channel.url);
            currentHls.attachMedia(video);
            
            currentHls.on(Hls.Events.MANIFEST_PARSED, (event, data) => {
                renderAudioTracks(data.audioTracks);
                renderSubtitleTracks(data.subtitleTracks);
                video.play().catch(error => showError(error.message));
            });
            
            currentHls.on(Hls.Events.ERROR, (event, data) => {
                handleHlsError(data);
            });
        }

        function renderAudioTracks(audioTracks) {
            const container = document.getElementById('audioTracks');
            container.innerHTML = '';
            
            audioTracks.forEach((track, index) => {
                const btn = document.createElement('button');
                btn.className = 'track-btn';
                btn.textContent = track.name || `Àudio ${index + 1}`;
                btn.onclick = () => {
                    currentHls.audioTrack = index;
                    setActiveButton(btn, container);
                };
                if(track.default) btn.classList.add('active');
                container.appendChild(btn);
            });
        }

        function renderSubtitleTracks(subtitleTracks) {
            const container = document.getElementById('subtitleTracks');
            container.innerHTML = '';
            
            subtitleTracks.forEach((track, index) => {
                const btn = document.createElement('button');
                btn.className = 'track-btn';
                btn.textContent = track.name || `Subtítols ${index + 1}`;
                btn.onclick = () => {
                    currentHls.subtitleTrack = index;
                    setActiveButton(btn, container);
                };
                container.appendChild(btn);
            });
        }

        function setActiveButton(activeBtn, container) {
            container.querySelectorAll('.track-btn').forEach(btn => 
                btn.classList.remove('active')
            );
            activeBtn.classList.add('active');
        }

        function handleHlsError(data) {
            let errorMsg = `Error: ${data.details}`;
            if(data.response?.code) errorMsg += ` (Codi ${data.response.code})`;
            showError(errorMsg);
            
            if(data.fatal) {
                switch(data.type) {
                    case Hls.ErrorTypes.NETWORK_ERROR:
                        currentHls.startLoad();
                        break;
                    case Hls.ErrorTypes.MEDIA_ERROR:
                        currentHls.recoverMediaError();
                        break;
                    default:
                        currentHls.destroy();
                        break;
                }
            }
        }

        function showError(message) {
            const errorDiv = document.getElementById('errorMessage');
            errorDiv.textContent = message;
            errorDiv.style.display = 'block';
            setTimeout(() => errorDiv.style.display = 'none', 5000);
        }

        // Inici automàtic
        if(Hls.isSupported()) {
            loadPlaylist();
        } else {
            showError('El teu navegador no suporta aquest tipus de reproducció');
        }
    </script>
</body>
</html>