<!DOCTYPE html>
<html lang="ca">
<head>
<meta charset="UTF-8">
<title>Gràfic Precipitació</title>
<style>
body {
  font-family: Arial, sans-serif;
  background: #e9f5ff;
  color: #222;
  padding: 2em;
}
.chart-container {
  max-width: 1050px;
  margin: 2em auto;
  background: #fff;
  border-radius: 8px;
  box-shadow: 0 2px 8px rgba(0,0,0,0.1);
  padding: 2em 1em;
}
</style>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body>
<div class="chart-container">
  <h3 style="text-align:center;">Precipitació diària últims 30 dies</h3>
  <canvas id="precChart" width="900" height="300"></canvas>
</div>
<script>
const municipis = [
  { nom: "Espluga de Francolí", lat: 41.3862, lon: 1.1022 },
  { nom: "Les Borges Blanques", lat: 41.5194, lon: 0.8670 }
];
function getHistoricalUrl(lat, lon, start, end) {
  return `https://archive-api.open-meteo.com/v1/archive?latitude=${lat}&longitude=${lon}&daily=precipitation_sum&start_date=${start}&end_date=${end}&timezone=Europe/Madrid`;
}
function fetchAndDrawPrecipChart() {
  const today = new Date();
  const endDate = today.toISOString().slice(0,10);
  const startDate = new Date(today.getTime() - 29*24*3600*1000).toISOString().slice(0,10);

  Promise.all(municipis.map(m =>
    fetch(getHistoricalUrl(m.lat, m.lon, startDate, endDate)).then(r => r.json())
  )).then(histResults => {
    const dates30 = histResults[0].daily.time;
    const precip0 = histResults[0].daily.precipitation_sum;
    const precip1 = histResults[1].daily.precipitation_sum;

    const total0 = precip0.reduce((a,b) => a + (b || 0), 0);
    const total1 = precip1.reduce((a,b) => a + (b || 0), 0);

    const ctx = document.getElementById('precChart').getContext('2d');
    new Chart(ctx, {
      type: 'bar',
      data: {
        labels: dates30,
        datasets: [
          {
            label: `Espluga de Francolí (${total0.toFixed(1)} mm)`,
            data: precip0,
            backgroundColor: 'rgba(54, 162, 235, 0.5)',
            borderColor: 'rgba(54, 162, 235, 1)',
            borderWidth: 1
          },
          {
            label: `Les Borges Blanques (${total1.toFixed(1)} mm)`,
            data: precip1,
            backgroundColor: 'rgba(255, 99, 132, 0.5)',
            borderColor: 'rgba(255, 99, 132, 1)',
            borderWidth: 1
          }
        ]
      },
      options: {
        responsive: true,
        scales: {
          x: { title: { display: true, text: 'Data' } },
          y: { title: { display: true, text: 'mm' }, beginAtZero: true }
        }
      }
    });
  }).catch(error => {
    document.getElementById('precChart').insertAdjacentHTML('afterend',
      "<div style='color:#c00;text-align:center;'>No s'han pogut carregar les dades.</div>");
    console.error(error);
  });
}
fetchAndDrawPrecipChart();
</script>
</body>
</html>
