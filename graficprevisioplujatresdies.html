<!DOCTYPE html>
<html lang="ca">
<head>
<meta charset="UTF-8" />
<title>Previsió Pluja Hora a Hora (3 dies, a partir hora actual)</title>
<style>
body {
  font-family: Arial, sans-serif;
  background: #e9f5ff;
  color: #222;
  padding: 2em;
}
.chart-container {
  max-width: 1050px;
  margin: 2em auto;
  background: #fff;
  border-radius: 8px;
  box-shadow: 0 2px 8px rgba(0,0,0,0.1);
  padding: 2em 1em;
}
</style>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body>
<div class="chart-container">
  <h3 style="text-align:center;">Previsió pluja hora a hora (3 dies, a partir hora actual)</h3>
  <canvas id="rainHourChart" width="900" height="320"></canvas>
</div>
<script>
const municipis = [
  { nom: "Espluga de Francolí", lat: 41.3862, lon: 1.1022 },
  { nom: "Les Borges Blanques", lat: 41.5194, lon: 0.8670 }
];

function getUrl(lat, lon) {
  // No forecast_days param here; we fetch 7 days but will slice to 3*24 hours starting from current hour
  return `https://api.open-meteo.com/v1/forecast?latitude=${lat}&longitude=${lon}&hourly=precipitation&timezone=Europe/Madrid`;
}

function getCurrentHourIndex(times) {
  const now = new Date();
  for (let i = 0; i < times.length; i++) {
    const t = new Date(times[i]);
    if (t >= now) return i;
  }
  return 0; // fallback if none found
}

function fetchAndDrawRainHourChartFromCurrentHour() {
  Promise.all(municipis.map(m =>
    fetch(getUrl(m.lat, m.lon)).then(r => r.json())
  )).then(results => {
    const hourlys0 = results[0].hourly;
    const hourlys1 = results[1].hourly;

    // Find index of current hour or next hour in forecast time arrays
    const startIndex0 = getCurrentHourIndex(hourlys0.time);
    const startIndex1 = getCurrentHourIndex(hourlys1.time);
    // Use the earliest start index to synchronize labels
    const startIndex = Math.min(startIndex0, startIndex1);

    // Extract slices for 3 days = 72 hours starting at current hour
    const endIndex = startIndex + 72;

    const rainLabels = hourlys0.time.slice(startIndex, endIndex).map(t => t.slice(5,16).replace('T',' '));
    const rainData0 = hourlys0.precipitation.slice(startIndex, endIndex);
    const rainData1 = hourlys1.precipitation.slice(startIndex, endIndex);

    const ctx = document.getElementById('rainHourChart').getContext('2d');
    new Chart(ctx, {
      type: 'bar',
      data: {
        labels: rainLabels,
        datasets: [
          {
            label: 'Espluga de Francolí',
            data: rainData0,
            backgroundColor: 'rgba(54, 162, 235, 0.5)',
            borderColor: 'rgba(54, 162, 235, 1)',
            borderWidth: 1
          },
          {
            label: 'Les Borges Blanques',
            data: rainData1,
            backgroundColor: 'rgba(255, 99, 132, 0.5)',
            borderColor: 'rgba(255, 99, 132, 1)',
            borderWidth: 1
          }
        ]
      },
      options: {
        responsive: true,
        plugins: { legend: { position: 'top' } },
        scales: {
          x: { title: { display: true, text: 'Hora' }, ticks: { maxTicksLimit: 24 } },
          y: { title: { display: true, text: 'mm/hora' }, beginAtZero: true }
        }
      }
    });
  }).catch(error => {
    document.getElementById('rainHourChart').insertAdjacentHTML('afterend',
      "<div style='color:#c00;text-align:center;'>No s'han pogut carregar les dades.</div>");
    console.error(error);
  });
}

fetchAndDrawRainHourChartFromCurrentHour();
</script>
</body>
</html>
