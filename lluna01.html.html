<!DOCTYPE html>
<html lang="ca">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>Fase de la Lluna Actual</title>
    <style>
        /* CSS3 */
        body {
            font-family: 'Arial', sans-serif;
            margin: 0;
            padding: 0;
            background-color: #121212;
            color: #ffffff;
            text-align: center;
            overflow-x: hidden;
        }

        .container {
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
        }

        h1 {
            color: #f0c674;
            margin-bottom: 30px;
        }

        .moon-container {
            position: relative;
            width: 300px;
            height: 300px;
            margin: 30px auto;
            border-radius: 50%;
            background-color: #222;
            box-shadow: 0 0 20px rgba(240, 198, 116, 0.3);
        }

        .moon {
            width: 100%;
            height: 100%;
            border-radius: 50%;
            background-image: url('https://svs.gsfc.nasa.gov/vis/a000000/a004800/a004874/moon.0001.jpg');
            background-size: cover;
            background-position: center;
            filter: grayscale(100%) brightness(0.9);
            position: relative;
            overflow: hidden;
        }

        .moon-phase {
            position: absolute;
            width: 100%;
            height: 100%;
            border-radius: 50%;
            background-color: #121212;
        }

        .moon-info {
            background-color: rgba(0, 0, 0, 0.7);
            padding: 15px;
            border-radius: 10px;
            margin: 20px 0;
            box-shadow: 0 0 10px rgba(240, 198, 116, 0.2);
        }

        .vr-container {
            width: 100%;
            height: 300px;
            margin: 30px auto;
            background-color: #000;
            border-radius: 10px;
            overflow: hidden;
            position: relative;
            border: 2px solid #f0c674;
        }

        .vr-moon {
            width: 60px;
            height: 60px;
            border-radius: 50%;
            background-image: url('https://svs.gsfc.nasa.gov/vis/a000000/a004800/a004874/moon.0001.jpg');
            background-size: cover;
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            box-shadow: 0 0 20px rgba(240, 198, 116, 0.8);
        }

        .vr-orbit {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 200px;
            height: 200px;
            border: 1px dashed rgba(240, 198, 116, 0.5);
            border-radius: 50%;
        }

        .vr-horizon {
            position: absolute;
            bottom: 0;
            width: 100%;
            height: 40%;
            background: linear-gradient(to bottom, rgba(32, 32, 32, 0.1), rgba(32, 32, 32, 0.8));
            border-top: 1px solid rgba(240, 198, 116, 0.3);
        }

        .info-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
            margin-top: 20px;
        }

        .info-card {
            background-color: rgba(0, 0, 0, 0.5);
            padding: 15px;
            border-radius: 8px;
            border-left: 3px solid #f0c674;
        }

        button {
            background-color: #f0c674;
            color: #121212;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            font-weight: bold;
            cursor: pointer;
            margin: 10px;
            transition: all 0.3s;
        }

        button:hover {
            background-color: #e6b860;
            transform: scale(1.05);
        }

        @media (max-width: 600px) {
            .moon-container {
                width: 200px;
                height: 200px;
            }
            
            .info-grid {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>Fase de la Lluna Actual</h1>
        
        <div class="moon-container">
            <div class="moon" id="moon"></div>
            <div class="moon-phase" id="moonPhase"></div>
        </div>
        
        <div class="moon-info">
            <h2 id="moonPhaseName">Carregant...</h2>
            <p id="moonIllumination">Il·luminació: --%</p>
            <p id="moonAge">Edat: -- dies</p>
            
            <div class="info-grid">
                <div class="info-card">
                    <h3>Sortida de la Lluna</h3>
                    <p id="moonrise">--:--</p>
                </div>
                <div class="info-card">
                    <h3>Posta de la Lluna</h3>
                    <p id="moonset">--:--</p>
                </div>
            </div>
        </div>
        
        <button id="vrToggle">Activar Realitat Virtual</button>
        
        <div class="vr-container" id="vrContainer" style="display: none;">
            <div class="vr-orbit"></div>
            <div class="vr-moon" id="vrMoon"></div>
            <div class="vr-horizon"></div>
        </div>
        
        <p id="orientationInfo">Gira el teu dispositiu per veure l'òrbita de la lluna</p>
    </div>

    <script>
        // JavaScript per a la fase de la lluna i realitat virtual
        document.addEventListener('DOMContentLoaded', function() {
            // Elements del DOM
            const moonPhaseElement = document.getElementById('moonPhase');
            const moonPhaseNameElement = document.getElementById('moonPhaseName');
            const moonIlluminationElement = document.getElementById('moonIllumination');
            const moonAgeElement = document.getElementById('moonAge');
            const moonriseElement = document.getElementById('moonrise');
            const moonsetElement = document.getElementById('moonset');
            const vrToggleButton = document.getElementById('vrToggle');
            const vrContainer = document.getElementById('vrContainer');
            const vrMoon = document.getElementById('vrMoon');
            const orientationInfo = document.getElementById('orientationInfo');
            
            let vrActive = false;
            let userLocation = null;
            
            // Calcula la fase actual de la lluna
            function calculateMoonPhase(date) {
                // Càlcul basat en l'algoritme de Conway
                const year = date.getFullYear();
                const month = date.getMonth() + 1;
                const day = date.getDate();
                
                let r = year % 100;
                r %= 19;
                if (r > 9) r -= 19;
                r = ((r * 11) % 30) + month + day;
                if (month < 3) r += 2;
                
                let phase = (r + (year < 2000 ? -4 : 8.3)) % 30;
                phase = phase < 0 ? phase + 30 : phase;
                
                // Normalitzar entre 0 i 1
                const phaseNormalized = phase / 29.5;
                
                return {
                    phase: phaseNormalized,
                    age: phase,
                    illumination: 0.5 * (1 - Math.cos(2 * Math.PI * phaseNormalized))
                };
            }
            
            // Actualitza la visualització de la fase de la lluna
            function updateMoonPhaseVisualization(phaseData) {
                const phase = phaseData.phase;
                let phaseName = '';
                let clipPath = '';
                
                if (phase < 0.05 || phase >= 0.95) {
                    phaseName = 'Lluna Nova';
                    clipPath = 'polygon(0% 0%, 0% 100%, 100% 100%, 100% 0%)';
                } else if (phase < 0.45) {
                    phaseName = 'Lluna Creixent';
                    const x = 50 - (phase * 200);
                    clipPath = `polygon(${50 + x}% 0%, ${50 + x}% 100%, 50% 100%, 50% 0%)`;
                } else if (phase < 0.55) {
                    phaseName = 'Lluna Plena';
                    clipPath = 'polygon(0% 0%, 0% 100%, 100% 100%, 100% 0%)';
                } else {
                    phaseName = 'Lluna Minvant';
                    const x = 50 - ((1 - phase) * 200);
                    clipPath = `polygon(${50 - x}% 0%, ${50 - x}% 100%, 50% 100%, 50% 0%)`;
                }
                
                moonPhaseElement.style.clipPath = clipPath;
                moonPhaseNameElement.textContent = phaseName;
                moonIlluminationElement.textContent = `Il·luminació: ${Math.round(phaseData.illumination * 100)}%`;
                moonAgeElement.textContent = `Edat: ${phaseData.age.toFixed(1)} dies`;
            }
            
            // Obtenir la localització de l'usuari
            function getUserLocation() {
                return new Promise((resolve, reject) => {
                    if (navigator.geolocation) {
                        navigator.geolocation.getCurrentPosition(
                            position => resolve(position.coords),
                            error => reject(error)
                        );
                    } else {
                        reject(new Error('Geolocalització no suportada'));
                    }
                });
            }
            
            // Obtenir hores de sortida i postada de la lluna
            async function getMoonTimes(coords) {
                try {
                    const date = new Date();
                    const dateStr = `${date.getFullYear()}-${date.getMonth() + 1}-${date.getDate()}`;
                    const response = await fetch(`https://api.sunrise-sunset.org/json?lat=${coords.latitude}&lng=${coords.longitude}&date=${dateStr}&formatted=0`);
                    const data = await response.json();
                    
                    if (data.status === 'OK') {
                        const moonrise = new Date(data.results.moonrise);
                        const moonset = new Date(data.results.moonset);
                        
                        moonriseElement.textContent = moonrise.toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});
                        moonsetElement.textContent = moonset.toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});
                    }
                } catch (error) {
                    console.error('Error obtenint les hores de la lluna:', error);
                    moonriseElement.textContent = 'No disponible';
                    moonsetElement.textContent = 'No disponible';
                }
            }
            
            // Actualitzar la posició de la lluna en realitat virtual
            function updateVRMoonPosition(beta, gamma) {
                if (!vrActive) return;
                
                // Convertir angles a coordenades en el contenidor VR
                const centerX = vrContainer.offsetWidth / 2;
                const centerY = vrContainer.offsetHeight / 2;
                const radius = 100;
                
                // Normalitzar angles (beta: -180 a 180, gamma: -90 a 90)
                const normalizedBeta = (beta + 180) / 360; // 0 a 1
                const normalizedGamma = (gamma + 90) / 180; // 0 a 1
                
                // Calcular posició (simulant una òrbita circular)
                const angle = normalizedBeta * Math.PI * 2;
                const x = centerX + Math.cos(angle) * radius;
                const y = centerY + Math.sin(angle) * radius * (1 - normalizedGamma * 0.5);
                
                vrMoon.style.left = `${x}px`;
                vrMoon.style.top = `${y}px`;
                
                // Actualitzar la mida basada en l'altura (simulant perspectiva)
                const size = 40 + (normalizedGamma * 40);
                vrMoon.style.width = `${size}px`;
                vrMoon.style.height = `${size}px`;
            }
            
            // Gestionar l'orientació del dispositiu
            function handleOrientation(event) {
                if (!vrActive) return;
                
                const beta = event.beta;  // -180 to 180
                const gamma = event.gamma; // -90 to 90
                
                updateVRMoonPosition(beta, gamma);
                
                // Actualitzar informació d'orientació
                orientationInfo.textContent = `Orientalció: Beta: ${beta.toFixed(1)}°, Gamma: ${gamma.toFixed(1)}°`;
            }
            
            // Activar/desactivar realitat virtual
            vrToggleButton.addEventListener('click', function() {
                vrActive = !vrActive;
                
                if (vrActive) {
                    vrContainer.style.display = 'block';
                    vrToggleButton.textContent = 'Desactivar Realitat Virtual';
                    orientationInfo.style.display = 'block';
                    
                    // Demanar permís per a l'orientació en iOS 13+
                    if (typeof DeviceOrientationEvent !== 'undefined' && typeof DeviceOrientationEvent.requestPermission === 'function') {
                        DeviceOrientationEvent.requestPermission()
                            .then(response => {
                                if (response === 'granted') {
                                    window.addEventListener('deviceorientation', handleOrientation);
                                }
                            })
                            .catch(console.error);
                    } else {
                        window.addEventListener('deviceorientation', handleOrientation);
                    }
                } else {
                    vrContainer.style.display = 'none';
                    vrToggleButton.textContent = 'Activar Realitat Virtual';
                    orientationInfo.style.display = 'none';
                    window.removeEventListener('deviceorientation', handleOrientation);
                }
            });
            
            // Inicialització
            async function init() {
                const now = new Date();
                const moonPhaseData = calculateMoonPhase(now);
                updateMoonPhaseVisualization(moonPhaseData);
                
                try {
                    userLocation = await getUserLocation();
                    await getMoonTimes(userLocation);
                } catch (error) {
                    console.error('Error obtenint la localització:', error);
                    moonriseElement.textContent = 'Activa la localització';
                    moonsetElement.textContent = 'Activa la localització';
                }
            }
            
            init();
        });
    </script>
</body>
</html>