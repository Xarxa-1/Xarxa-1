<!DOCTYPE html>
<html>
<head>
    <title>Mapa Interactiu 360º - L'Espluga de Francolí</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.7.1/dist/leaflet.css" />
    <style>
        #map {
            height: 100vh;
            width: 100%;
            transition: transform 0.3s;
        }

        .controls {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 1000;
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        button {
            padding: 12px;
            background: #2196F3;
            color: white;
            border: none;
            border-radius: 50%;
            cursor: pointer;
            box-shadow: 0 2px 5px rgba(0,0,0,0.3);
            width: 50px;
            height: 50px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .compass-container {
            position: fixed;
            bottom: 30px;
            right: 30px;
            z-index: 1000;
            background: rgba(255, 255, 255, 0.9);
            border-radius: 50%;
            padding: 10px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.3);
        }

        .compass {
            width: 50px;
            height: 50px;
            background: url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="%23000000"><path d="M12 2a10 10 0 1 0 10 10A10 10 0 0 0 12 2zm0 18a8 8 0 1 1 8-8 8 8 0 0 1-8 8zm4.24-7.76l-5 2a1 1 0 0 1-1.28-1.28l2-5a1 1 0 0 1 1.28-1.28l5 2a1 1 0 0 1 0 1.82zM12 13a1 1 0 1 1 1-1 1 1 0 0 1-1 1z"/></svg>') center/contain no-repeat;
            transition: transform 0.1s;
        }

        .input-container {
            position: fixed;
            bottom: 30px;
            left: 20px;
            z-index: 1000;
            background: rgba(255, 255, 255, 0.9);
            padding: 15px;
            border-radius: 10px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.2);
            max-width: 300px;
        }

        .fixed-point-label {
            background: rgba(0, 0, 0, 0.8);
            color: white;
            padding: 6px 12px;
            border-radius: 4px;
            font-size: 12px;
            font-family: Arial, sans-serif;
        }

        #result {
            margin-top: 10px;
            font-weight: bold;
            color: #333;
        }

        .debug-info {
            position: fixed;
            top: 20px;
            left: 20px;
            background: rgba(0,0,0,0.7);
            color: white;
            padding: 10px;
            border-radius: 5px;
            font-family: monospace;
            z-index: 1000;
        }
    </style>
</head>
<body>
    <div class="controls">
        <button onclick="toggleOrientation()" title="Activar Orientació">🧭</button>
        <button onclick="resetNorth()" title="Restablir Nord">⬆️</button>
    </div>

    <div class="compass-container">
        <div class="compass" id="compass"></div>
    </div>

    <div class="input-container">
        <div class="input-group">
            <input type="number" step="any" id="lat1" placeholder="Latitud 1">
            <input type="number" step="any" id="lng1" placeholder="Longitud 1">
            <button onclick="addPoint(1)">Punt 1</button>
        </div>
        <div class="input-group">
            <input type="number" step="any" id="lat2" placeholder="Latitud 2">
            <input type="number" step="any" id="lng2" placeholder="Longitud 2">
            <button onclick="addPoint(2)">Punt 2</button>
        </div>
        <div id="result"></div>
    </div>

    <div class="debug-info" id="debug"></div>
    <div id="map"></div>

    <script src="https://unpkg.com/leaflet@1.7.1/dist/leaflet.js"></script>
    <script>
        let map, markers = [], polyline = null;
        let isOrientationActive = false;
        let watchId = null;
        let userMarker = null;
        let lastAlpha = 0;

        const fixedPoints = [
            {
                name: "Església Sant Miquel",
                coords: [41.39595, 1.10201],
                color: 'blue'
            },
            {
                name: "Celler Cooperatiu",
                coords: [41.39416, 1.10184],
                color: 'green'
            }
        ];

        function initMap() {
            map = L.map('map', {
                center: [41.3950, 1.1025],
                zoom: 17,
                maxZoom: 21,
                inertia: false
            });

            L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}', {
                attribution: 'Tiles © Esri',
                maxZoom: 21
            }).addTo(map);

            fixedPoints.forEach(point => {
                L.marker(point.coords, {
                    icon: new L.Icon({
                        iconUrl: `https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-2x-${point.color}.png`,
                        shadowUrl: 'https://cdnjs.cloudflare.com/ajax/libs/leaflet/0.7.7/images/marker-shadow.png',
                        iconSize: [25, 41],
                        iconAnchor: [12, 41],
                        popupAnchor: [1, -34],
                        shadowSize: [41, 41]
                    }),
                    interactive: false
                }).bindTooltip(point.name, {
                    permanent: true,
                    direction: 'right',
                    className: 'fixed-point-label',
                    offset: [10, 0]
                }).addTo(map);
            });

            map.on('click', e => {
                if(markers.length >= 2) clearMarkers();
                addMarker(e.latlng);
                updateInputs(e.latlng);
            });
        }

        function addMarker(latlng) {
            const marker = L.marker(latlng).addTo(map);
            markers.push(marker);
            if(markers.length === 2) updateMeasurement();
        }

        function updateInputs(latlng) {
            const target = markers.length === 1 ? ['lat1', 'lng1'] : ['lat2', 'lng2'];
            document.getElementById(target[0]).value = latlng.lat.toFixed(6);
            document.getElementById(target[1]).value = latlng.lng.toFixed(6);
        }

        function clearMarkers() {
            markers.forEach(m => map.removeLayer(m));
            markers = [];
            if(polyline) map.removeLayer(polyline);
            document.getElementById('result').textContent = '';
        }

        function updateMeasurement() {
            const p1 = markers[0].getLatLng();
            const p2 = markers[1].getLatLng();

            polyline = L.polyline([p1, p2], {color: 'red', weight: 3}).addTo(map);
            document.getElementById('result').textContent = `Distància: ${p1.distanceTo(p2).toFixed(2)} metres`;
        }

        async function toggleOrientation() {
            try {
                if(typeof DeviceOrientationEvent.requestPermission === 'function') {
                    const permission = await DeviceOrientationEvent.requestPermission();
                    if(permission !== 'granted') return;
                }

                if(!isOrientationActive) {
                    startTracking();
                    window.addEventListener('deviceorientation', handleOrientation);
                    document.getElementById('debug').textContent = "Orientació activada";
                } else {
                    resetNorth();
                }
                isOrientationActive = !isOrientationActive;

            } catch(error) {
                document.getElementById('debug').textContent = `Error: ${error.message}`;
            }
        }

        function handleOrientation(event) {
            let alpha = event.webkitCompassHeading || event.alpha;
            if(typeof alpha === 'undefined') return;

            const smoothedAlpha = alpha * 0.2 + lastAlpha * 0.8;
            lastAlpha = smoothedAlpha;

            document.getElementById('map').style.transform = `rotate(${-smoothedAlpha}deg)`;
            document.getElementById('compass').style.transform = `rotate(${smoothedAlpha}deg)`;

            if(userMarker) userMarker.setRotationAngle(smoothedAlpha);
            document.getElementById('debug').textContent = `Rotació: ${smoothedAlpha.toFixed(1)}°`;
        }

        function startTracking() {
            watchId = navigator.geolocation.watchPosition(
                position => {
                    const {latitude, longitude} = position.coords;
                    if(!userMarker) {
                        userMarker = L.marker([latitude, longitude], {
                            icon: new L.Icon.Default(),
                            rotationAngle: lastAlpha
                        }).addTo(map);
                    } else {
                        userMarker.setLatLng([latitude, longitude]);
                    }
                    map.setView([latitude, longitude], 18);
                },
                error => console.error("Error GPS:", error),
                {enableHighAccuracy: true}
            );
        }

        function resetNorth() {
            document.getElementById('map').style.transform = 'rotate(0deg)';
            document.getElementById('compass').style.transform = 'rotate(0deg)';
            if(userMarker) userMarker.setRotationAngle(0);
            if(watchId) navigator.geolocation.clearWatch(watchId);
            window.removeEventListener('deviceorientation', handleOrientation);
            document.getElementById('debug').textContent = "Orientació desactivada";
        }

        function addPoint(num) {
            const lat = parseFloat(document.getElementById(`lat${num}`).value);
            const lng = parseFloat(document.getElementById(`lng${num}`).value);

            if(isNaN(lat) || isNaN(lng)) {
                alert("Si us plau, introdueix coordenades vàlides");
                return;
            }

            addMarker(L.latLng(lat, lng));
            if(markers.length === 2) updateMeasurement();
        }

        window.onload = initMap;
    </script>
</body>
</html>