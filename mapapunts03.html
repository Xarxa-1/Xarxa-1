<!DOCTYPE html>
<html lang="ca">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mapa interactiu - Orientació real</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.7.1/dist/leaflet.css" />
    <style>
        body {
            margin: 0;
            padding: 0;
            font-family: Arial, sans-serif;
            overflow: hidden;
        }
        #map {
            width: 100%;
            height: 100vh;
            transition: transform 0.1s ease;
        }
        .controls {
            position: absolute;
            top: 10px;
            right: 10px;
            z-index: 1000;
            display: flex;
            flex-direction: column;
        }
        .zoom-btn {
            background-color: white;
            border: 1px solid #ccc;
            border-radius: 4px;
            padding: 8px 12px;
            margin: 4px;
            cursor: pointer;
            font-size: 16px;
            box-shadow: 0 1px 5px rgba(0,0,0,0.2);
        }
        .zoom-btn:hover {
            background-color: #f4f4f4;
        }
        .point-label {
            background-color: white;
            padding: 2px 6px;
            border-radius: 4px;
            border: 1px solid #ccc;
            font-size: 12px;
            white-space: nowrap;
            transform: translateY(-50%);
        }
        .map-tooltip {
            background-color: white;
            border: 1px solid #ccc;
            border-radius: 4px;
            padding: 2px 6px;
            font-size: 12px;
        }
        .compass {
            position: absolute;
            bottom: 20px;
            right: 20px;
            z-index: 1000;
            background-color: white;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 1px 5px rgba(0,0,0,0.2);
            cursor: pointer;
            font-weight: bold;
        }
        .compass.active {
            background-color: #4CAF50;
            color: white;
        }
    </style>
</head>
<body>
    <div id="map"></div>
    <div class="controls">
        <button class="zoom-btn" id="zoom-in">+</button>
        <button class="zoom-btn" id="zoom-out">-</button>
    </div>
    <div class="compass" id="compass">N</div>

    <script src="https://unpkg.com/leaflet@1.7.1/dist/leaflet.js"></script>
    <script>
        // Punts d'interès
        const points = [
            { id: 1, name: "Esglèsia", lat: 41.396712, lon: 1.103376, alt: 412, color: '#FF0000' },
            { id: 2, name: "Ermita", lat: 41.3731, lon: 1.11065, alt: 560, color: '#00FF00' },
            { id: 3, name: "Sant Bernat", lat: 41.388193, lon: 1.083005, alt: 456, color: '#0000FF' },
            { id: 4, name: "Roca de la Manxa", lat: 41.426297, lon: 1.115281, alt: 499, color: '#FFFF00' },
            { id: 5, name: "Nou Lloc 1", lat: 41.52205, lon: 0.868813, alt: 353, color: '#FF00FF' },
            { id: 6, name: "Novacoop", lat: 41.520159, lon: 0.0862992, alt: 353, color: '#00FFFF' }
        ];

        let map;
        let currentPositionMarker;
        let currentPosition = null;
        let pointMarkers = [];
        let lines = [];
        let currentHeading = 0;
        let isTrackingOrientation = false;
        let compassElement = document.getElementById('compass');

        // Inicialitza el mapa
        function initMap() {
            map = L.map('map').setView([41.3925, 2.14], 12);

            // Afegeix capa del mapa satèl·lit
            L.tileLayer('https://mt1.google.com/vt/lyrs=s&x={x}&y={y}&z={z}', {
                attribution: 'Imatges © <a href="https://www.google.com/maps">Google Maps</a>',
                maxZoom: 20,
                subdomains: ['mt0','mt1','mt2','mt3']
            }).addTo(map);

            // Obtenir la posició actual
            if (navigator.geolocation) {
                navigator.geolocation.getCurrentPosition(
                    position => {
                        currentPosition = {
                            lat: position.coords.latitude,
                            lon: position.coords.longitude
                        };
                        updateMapWithPosition();
                        // Inicia el seguiment d'orientació automàticament
                        toggleOrientationTracking();
                    },
                    error => {
                        console.error("Error obtenint la posició:", error);
                        alert("No s'ha pogut obtenir la teva posició. Es mostrarà una vista per defecte.");
                        updateMapWithPosition();
                    },
                    { enableHighAccuracy: true }
                );
            } else {
                alert("El teu navegador no suporta geolocalització. Es mostrarà una vista per defecte.");
                updateMapWithPosition();
            }

            // Configura botons de zoom
            document.getElementById('zoom-in').addEventListener('click', () => {
                map.zoomIn();
            });
            document.getElementById('zoom-out').addEventListener('click', () => {
                map.zoomOut();
            });

            // Botó per activar/desactivar orientació
            compassElement.addEventListener('click', toggleOrientationTracking);
        }

        // Alterna el seguiment de l'orientació
        function toggleOrientationTracking() {
            if (isTrackingOrientation) {
                stopOrientationTracking();
                compassElement.classList.remove('active');
                compassElement.textContent = 'N';
            } else {
                startOrientationTracking();
                compassElement.classList.add('active');
                compassElement.textContent = '↻';
            }
        }

        // Inicia el seguiment de l'orientació
        function startOrientationTracking() {
            if (window.DeviceOrientationEvent) {
                if (typeof DeviceOrientationEvent.requestPermission === 'function') {
                    // Demanar permís en iOS 13+
                    DeviceOrientationEvent.requestPermission()
                        .then(permissionState => {
                            if (permissionState === 'granted') {
                                window.addEventListener('deviceorientation', handleOrientation);
                                isTrackingOrientation = true;
                            }
                        })
                        .catch(console.error);
                } else {
                    // Altres navegadors
                    window.addEventListener('deviceorientation', handleOrientation);
                    isTrackingOrientation = true;
                }
            } else {
                alert("El teu dispositiu no suporta l'orientació o no tens els permisos necessaris.");
            }
        }

        // Atura el seguiment de l'orientació
        function stopOrientationTracking() {
            window.removeEventListener('deviceorientation', handleOrientation);
            isTrackingOrientation = false;
            // Restableix la rotació del mapa
            document.getElementById('map').style.transform = 'rotate(0deg)';
        }

        // Gestiona els canvis d'orientació
        function handleOrientation(event) {
            // Obtenim el capçal (0-360 graus)
            if (event.webkitCompassHeading !== undefined) {
                // Safari
                currentHeading = event.webkitCompassHeading;
            } else if (event.alpha !== null) {
                // Altres navegadors
                currentHeading = (360 - event.alpha) % 360;
                if (event.absolute === false) {
                    // Ajust per a navegadors que no donen orientació absoluta
                    currentHeading = (currentHeading + window.orientation) % 360;
                }
            }

            // Rotem el mapa
            if (!isNaN(currentHeading)) {
                document.getElementById('map').style.transform = `rotate(${-currentHeading}deg)`;
                compassElement.style.transform = `rotate(${currentHeading}deg)`;
            }
        }

        // Actualitza el mapa amb la posició actual i punts d'interès
        function updateMapWithPosition() {
            // Neteja marcadors i línies anteriors
            if (currentPositionMarker) map.removeLayer(currentPositionMarker);
            pointMarkers.forEach(marker => map.removeLayer(marker));
            lines.forEach(line => map.removeLayer(line));
            pointMarkers = [];
            lines = [];

            // Centra el mapa en la posició actual o en una vista general dels punts
            if (currentPosition) {
                map.setView([currentPosition.lat, currentPosition.lon], 15);
                
                // Afegeix marcador de posició actual
                currentPositionMarker = L.circleMarker(
                    [currentPosition.lat, currentPosition.lon],
                    { 
                        radius: 8, 
                        color: '#FFFFFF',
                        weight: 2,
                        fillColor: '#3388ff', 
                        fillOpacity: 1 
                    }
                ).addTo(map);
                
                // Afegeix etiqueta a la posició actual
                currentPositionMarker.bindTooltip("La teva posició", { 
                    permanent: false, 
                    direction: 'top',
                    className: 'map-tooltip'
                }).openTooltip();
            } else {
                // Si no tenim posició, centra en una vista que mostri tots els punts
                const bounds = points.reduce((acc, point) => {
                    return acc.extend([point.lat, point.lon]);
                }, L.latLngBounds([points[0].lat, points[0].lon], [points[0].lat, points[0].lon]));
                map.fitBounds(bounds.pad(0.2));
            }

            // Afegeix punts d'interès i línies
            points.forEach(point => {
                // Crea marcador del punt
                const marker = L.circleMarker(
                    [point.lat, point.lon],
                    { 
                        radius: 6, 
                        color: '#FFFFFF',
                        weight: 2,
                        fillColor: point.color, 
                        fillOpacity: 1 
                    }
                ).addTo(map);
                
                // Afegeix etiqueta amb nom i altitud
                marker.bindTooltip(`${point.name} (${point.alt}m)`, { 
                    permanent: false, 
                    direction: 'top',
                    className: 'map-tooltip'
                });
                pointMarkers.push(marker);

                // Si tenim posició actual, dibuixa línia i etiqueta
                if (currentPosition) {
                    // Dibuixa línia
                    const line = L.polyline(
                        [[currentPosition.lat, currentPosition.lon], [point.lat, point.lon]],
                        { 
                            color: point.color, 
                            weight: 3, 
                            dashArray: '5,5',
                            opacity: 0.8
                        }
                    ).addTo(map);
                    lines.push(line);

                    // Calcula el punt mig per posar l'etiqueta
                    const midLat = (currentPosition.lat + point.lat) / 2;
                    const midLon = (currentPosition.lon + point.lon) / 2;
                    
                    // Crea etiqueta flotant
                    const label = L.marker([midLat, midLon], {
                        icon: L.divIcon({
                            className: 'point-label',
                            html: point.name,
                            iconSize: null
                        }),
                        zIndexOffset: 1000
                    }).addTo(map);
                    pointMarkers.push(label);
                }
            });
        }

        // Inicialitza el mapa quan es carrega la pàgina
        window.onload = initMap;
    </script>
</body>
</html>
