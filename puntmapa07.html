<!DOCTYPE html>
<html lang="ca">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>Realitat Augmentada - Línies de Destinació</title>
    <style>
        body {
            margin: 0;
            padding: 0;
            overflow: hidden;
            font-family: Arial, sans-serif;
            color: white;
        }
        
        #cameraContainer {
            position: fixed;
            top: 0;
            left: 0;
            width: 100vw;
            height: 100vh;
            z-index: 1;
        }
        
        #arCanvas {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: 2;
        }
        
        #controlPanel {
            position: fixed;
            bottom: 0;
            left: 0;
            width: 100%;
            background-color: rgba(0, 0, 0, 0.7);
            backdrop-filter: blur(5px);
            z-index: 10;
            border-top: 1px solid rgba(255, 255, 255, 0.2);
            transition: all 0.3s ease;
            overflow: hidden;
        }
        
        #controlPanel.minimized {
            height: 40px;
        }
        
        #controlPanel.maximized {
            height: 200px;
        }
        
        #togglePanel {
            width: 100%;
            height: 40px;
            display: flex;
            justify-content: center;
            align-items: center;
            cursor: pointer;
            font-weight: bold;
        }
        
        #panelContent {
            padding: 15px;
            display: flex;
            flex-direction: column;
        }
        
        #distancesContainer {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
            gap: 10px;
            margin-bottom: 15px;
        }
        
        .distanceItem {
            display: flex;
            align-items: center;
            font-size: 14px;
        }
        
        .colorIndicator {
            width: 12px;
            height: 12px;
            margin-right: 8px;
            border-radius: 2px;
        }
        
        #legend {
            display: flex;
            flex-wrap: wrap;
            gap: 15px;
            margin-top: 10px;
        }
        
        .legendItem {
            display: flex;
            align-items: center;
            font-size: 14px;
        }
        
        #loadingMessage {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background-color: rgba(0, 0, 0, 0.7);
            padding: 20px;
            border-radius: 10px;
            z-index: 100;
            text-align: center;
        }
        
        #errorMessage {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background-color: rgba(200, 0, 0, 0.7);
            padding: 20px;
            border-radius: 10px;
            z-index: 100;
            text-align: center;
            display: none;
        }
    </style>
</head>
<body>
    <div id="cameraContainer">
        <video id="cameraFeed" autoplay playsinline style="display: none;"></video>
        <canvas id="arCanvas"></canvas>
    </div>
    
    <div id="controlPanel" class="minimized">
        <div id="togglePanel">
            <span id="toggleIcon">▼</span> Menú
        </div>
        <div id="panelContent">
            <div id="distancesContainer"></div>
            <div id="legend"></div>
        </div>
    </div>
    
    <div id="loadingMessage">
        Carregant realitat augmentada...
        <div>Permet l'accés a la càmera i la ubicació</div>
    </div>
    
    <div id="errorMessage"></div>
    
    <script>
        // Configuració de destinacions
        const destinations = [
            { id: 1, name: "Esglèsia", lat: 41.396712, lon: 1.103376, alt: 412, color: '#FF0000' },
            { id: 2, name: "Ermita", lat: 41.3731, lon: 1.11065, alt: 560, color: '#00FF00' },
            { id: 3, name: "Sant Bernat", lat: 41.388193, lon: 1.083005, alt: 456, color: '#0000FF' },
            { id: 4, name: "Roca de la Manxa", lat: 41.426297, lon: 1.115281, alt: 499, color: '#FFFF00' },
            { id: 5, name: "Nou Lloc 1", lat: 41.52205, lon: 0.868813, alt: 353, color: '#FF00FF' },
            { id: 6, name: "Novacoop", lat: 41.520159, lon: 0.0862992, alt: 353, color: '#00FFFF' },
            { id: 7, name: "Poblet", lat: 41.380406, lon: 1.083457, alt: 460, color: 'green' },
            { id: 8, name: "La Pena", lat: 41.3597743, lon: 1.093488, alt: 800, color: 'lime' },
            { id: 9, name: "Tarragona", lat: 41.113685, lon: 1.256539, alt: 800, color: 'coral' },
            { id: 10, name: "Lleida", lat: 41.615100, lon: 0.627411, alt: 800, color: 'coral' }
        ];
        
        // Variables globals
        let userPosition = null;
        let distances = {};
        let cameraStream = null;
        let lastFrameTime = 0;
        const FPS = 30;
        
        // Elements del DOM
        const cameraFeed = document.getElementById('cameraFeed');
        const arCanvas = document.getElementById('arCanvas');
        const arContext = arCanvas.getContext('2d');
        const controlPanel = document.getElementById('controlPanel');
        const togglePanel = document.getElementById('togglePanel');
        const toggleIcon = document.getElementById('toggleIcon');
        const distancesContainer = document.getElementById('distancesContainer');
        const legend = document.getElementById('legend');
        const loadingMessage = document.getElementById('loadingMessage');
        const errorMessage = document.getElementById('errorMessage');
        
        // Inicialització
        window.addEventListener('load', init);
        
        function init() {
            // Configurar el canvas per ocupar tota la pantalla
            resizeCanvas();
            window.addEventListener('resize', resizeCanvas);
            
            // Configurar el panell de control
            togglePanel.addEventListener('click', toggleControlPanel);
            
            // Iniciar la càmera i la geolocalització
            Promise.all([
                startCamera(),
                getLocation()
            ]).then(() => {
                loadingMessage.style.display = 'none';
                requestAnimationFrame(renderAR);
            }).catch(error => {
                loadingMessage.style.display = 'none';
                showError(error.message);
            });
            
            // Inicialitzar la llegenda
            initLegend();
        }
        
        function resizeCanvas() {
            arCanvas.width = window.innerWidth;
            arCanvas.height = window.innerHeight;
        }
        
        function toggleControlPanel() {
            if (controlPanel.classList.contains('minimized')) {
                controlPanel.classList.remove('minimized');
                controlPanel.classList.add('maximized');
                toggleIcon.textContent = '▲';
            } else {
                controlPanel.classList.remove('maximized');
                controlPanel.classList.add('minimized');
                toggleIcon.textContent = '▼';
            }
        }
        
        function initLegend() {
            legend.innerHTML = '';
            destinations.forEach(dest => {
                const legendItem = document.createElement('div');
                legendItem.className = 'legendItem';
                
                const colorIndicator = document.createElement('div');
                colorIndicator.className = 'colorIndicator';
                colorIndicator.style.backgroundColor = dest.color;
                
                const nameSpan = document.createElement('span');
                nameSpan.textContent = dest.name;
                
                legendItem.appendChild(colorIndicator);
                legendItem.appendChild(nameSpan);
                legend.appendChild(legendItem);
            });
        }
        
        function updateDistances() {
            distancesContainer.innerHTML = '';
            
            destinations.forEach(dest => {
                if (distances[dest.id]) {
                    const distanceItem = document.createElement('div');
                    distanceItem.className = 'distanceItem';
                    
                    const colorIndicator = document.createElement('div');
                    colorIndicator.className = 'colorIndicator';
                    colorIndicator.style.backgroundColor = dest.color;
                    
                    const textSpan = document.createElement('span');
                    textSpan.textContent = `${dest.name}: ${distances[dest.id].toFixed(1)} km`;
                    
                    distanceItem.appendChild(colorIndicator);
                    distanceItem.appendChild(textSpan);
                    distancesContainer.appendChild(distanceItem);
                }
            });
        }
        
        async function startCamera() {
            try {
                cameraStream = await navigator.mediaDevices.getUserMedia({
                    video: {
                        facingMode: 'environment',
                        width: { ideal: 1920 },
                        height: { ideal: 1080 }
                    }
                });
                cameraFeed.srcObject = cameraStream;
                return new Promise((resolve) => {
                    cameraFeed.onloadedmetadata = () => {
                        resolve();
                    };
                });
            } catch (error) {
                throw new Error('No es pot accedir a la càmera: ' + error.message);
            }
        }
        
        function getLocation() {
            return new Promise((resolve, reject) => {
                if (!navigator.geolocation) {
                    reject(new Error('Geolocalització no suportada pel navegador'));
                }
                
                const options = {
                    enableHighAccuracy: true,
                    timeout: 5000,
                    maximumAge: 0
                };
                
                navigator.geolocation.watchPosition(
                    (position) => {
                        userPosition = {
                            lat: position.coords.latitude,
                            lon: position.coords.longitude,
                            alt: position.coords.altitude || 0,
                            accuracy: position.coords.accuracy,
                            heading: position.coords.heading,
                            speed: position.coords.speed
                        };
                        
                        // Calcular distàncies a totes les destinacions
                        destinations.forEach(dest => {
                            distances[dest.id] = calculateDistance(
                                userPosition.lat, userPosition.lon, userPosition.alt,
                                dest.lat, dest.lon, dest.alt
                            );
                        });
                        
                        updateDistances();
                        resolve();
                    },
                    (error) => {
                        reject(new Error('Error de geolocalització: ' + error.message));
                    },
                    options
                );
            });
        }
        
        function calculateDistance(lat1, lon1, alt1, lat2, lon2, alt2) {
            // Fórmula de Haversine per calcular distància en km
            const R = 6371; // Radi de la Terra en km
            const dLat = (lat2 - lat1) * Math.PI / 180;
            const dLon = (lon2 - lon1) * Math.PI / 180;
            const a = 
                Math.sin(dLat/2) * Math.sin(dLat/2) +
                Math.cos(lat1 * Math.PI / 180) * Math.cos(lat2 * Math.PI / 180) * 
                Math.sin(dLon/2) * Math.sin(dLon/2);
            const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
            const distance = R * c;
            
            // Afegim la diferència d'altitud (Pitàgores)
            const altDiff = Math.abs(alt2 - alt1) / 1000; // Convertim a km
            const totalDistance = Math.sqrt(distance * distance + altDiff * altDiff);
            
            return totalDistance;
        }
        
        function renderAR(timestamp) {
            // Limitar el frame rate
            if (timestamp - lastFrameTime < 1000 / FPS) {
                requestAnimationFrame(renderAR);
                return;
            }
            lastFrameTime = timestamp;
            
            // Netejar el canvas
            arContext.clearRect(0, 0, arCanvas.width, arCanvas.height);
            
            // Dibuixar el vídeo de la càmera
            if (cameraFeed.readyState === cameraFeed.HAVE_ENOUGH_DATA) {
                arContext.drawImage(cameraFeed, 0, 0, arCanvas.width, arCanvas.height);
            }
            
            // Dibuixar les línies AR si tenim la posició de l'usuari
            if (userPosition) {
                destinations.forEach(dest => {
                    drawARLine(dest);
                });
            }
            
            requestAnimationFrame(renderAR);
        }
        
        function drawARLine(destination) {
            // Aquest és un exemple simplificat. En una aplicació real, hauries de:
            // 1. Calcular l'azimut i l'elevació des de la posició actual fins a la destinació
            // 2. Utilitzar els sensors de l'dispositiu (giroscopi, acceleròmetre) per orientar les línies correctament
            
            // Com que no tenim accés als sensors de l'dispositiu en aquest exemple,
            // farem una simulació simplificada on les línies surten del centre de la pantalla
            
            const centerX = arCanvas.width / 2;
            const centerY = arCanvas.height / 2;
            
            // Angle aleatori per a la demostració (en una aplicació real seria calculat)
            const angle = Math.random() * Math.PI * 2;
            const length = 100 + Math.random() * 50;
            
            const endX = centerX + Math.cos(angle) * length;
            const endY = centerY + Math.sin(angle) * length;
            
            // Dibuixar la línia
            arContext.beginPath();
            arContext.moveTo(centerX, centerY);
            arContext.lineTo(endX, endY);
            arContext.strokeStyle = destination.color;
            arContext.lineWidth = 3;
            arContext.stroke();
            
            // Dibuixar el nom de la destinació
            arContext.fillStyle = destination.color;
            arContext.font = '16px Arial';
            arContext.fillText(destination.name, endX + 10, endY);
        }
        
        function showError(message) {
            errorMessage.textContent = message;
            errorMessage.style.display = 'block';
        }
    </script>
</body>
</html>