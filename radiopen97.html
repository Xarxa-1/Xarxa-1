<!DOCTYPE html>
<html lang="ca">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<link rel="icon" href="https://xarxa-1.github.io/Xarxa-1/radio1.png" type="image/png">
<link rel="shortcut icon" href="https://xarxa-1.github.io/Xarxa-1/radio1.png">
<link rel="apple-touch-icon" href="https://xarxa-1.github.io/Xarxa-1/radio1.png">
<title>-Ràdio-</title>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
<style>
@import url('https://fonts.googleapis.com/css2?family=Antonio:wght@300;400;500;600&display=swap');
:root {
  --primary: lime;
  --secondary: #9370DB;
  --dark: #121212;
  --dark-2: #1E1E1E;
  --dark-3: #2A2A2A;
  --dark-4: black;
  --text: #E0E0E0;
  --text-light: #A0A0A0;
}
body {
  font-family: 'Antonio', sans-serif;
  background-color: var(--dark);
  color: var(--text);
  display: flex;
  flex-direction: column;
  align-items: flex-start;
  min-height: 100vh;
  margin: 0;
  padding: 20px;
  padding-top: 40px;
  gap: 20px;
}
.player {
  display: flex;
  align-items: center;
  background-color: var(--dark-2);
  border-radius: 15px;
  padding: 15px 25px;
  box-shadow: 0 10px 25px rgba(0, 0, 0, 0.3);
  gap: 20px;
  width: 100%;
  max-width: 1000px;
  position: relative;
}
.close-player {
  position: absolute;
  top: 10px;
  right: 10px;
  background: rgba(255, 0, 0, 0.7);
  border: none;
  border-radius: 50%;
  width: 24px;
  height: 24px;
  color: white;
  cursor: pointer;
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: 12px;
  transition: all 0.2s;
}
.close-player:hover {
  background: rgba(255, 0, 0, 1);
  transform: scale(1.1);
}
.buttons-container {
  display: flex;
  gap: 10px;
  margin-top: 10px;
}
.add-player-btn {
  background: var(--dark-3);
  border: none;
  color: var(--text-light);
  padding: 10px 15px;
  border-radius: 20px;
  cursor: pointer;
  font-size: 14px;
  display: inline-flex;
  align-items: center;
  gap: 5px;
  transition: all 0.2s;
  font-family: 'Antonio', sans-serif;
}
.add-player-btn:hover {
  background: var(--primary);
  color: white;
}
.cover {
  width: 160px;
  height: 160px;
  border-radius: 8px;
  overflow: hidden;
  flex-shrink: 0;
  background-color: var(--dark-3);
  position: relative;
}
.disc {
  width: 100%;
  height: 100%;
  background-size: cover;
  background-position: center;
  animation: spin 20s linear infinite;
  animation-play-state: paused;
}
@keyframes spin {
  100% { transform: rotate(360deg); }
}
.info {
  min-width: 200px;
  position: relative;
}
.title {
  font-size: 26px;
  font-weight: 500;
  margin: 0;
  white-space: nowrap;
  overflow: hidden;
  text-overflow: ellipsis;
  cursor: pointer;
  transition: color 0.2s;
}
.title:hover {
  color: var(--primary);
}
.artist {
  font-size: 22px;
  color: var(--text-light);
  margin: 3px 0 0 0;
  display: -webkit-box;
  -webkit-line-clamp: 3;
  -webkit-box-orient: vertical;
  overflow: hidden;
  max-width: 100%;
  line-height: 1.3;
}
.progress-container {
  flex-grow: 1;
  height: 4px;
  background: var(--dark-3);
  border-radius: 2px;
  cursor: pointer;
  margin: 0 15px;
}
.progress {
  height: 100%;
  background: linear-gradient(90deg, var(--primary), var(--secondary));
  border-radius: 2px;
  width: 0%;
  transition: width 0.1s;
}

/* Controls Section */
.controls-section {
  display: flex;
  flex-direction: column;
  align-items: center;
  gap: 10px;
  min-width: 120px;
}
.controls {
  display: flex;
  gap: 10px;
  align-items: center;
}
.btn {
  width: 36px;
  height: 36px;
  border-radius: 50%;
  background: var(--dark-3);
  border: none;
  color: var(--text);
  cursor: pointer;
  transition: all 0.2s;
  display: flex;
  align-items: center;
  justify-content: center;
}
.btn:hover {
  background: var(--primary);
  color: var(--dark-3);
  transform: scale(1.05);
}
.btn.play {
  width: 42px;
  height: 42px;
  color: var(--dark-3);
  background: var(--primary);
}
.btn.play:hover {
  color: var(--dark-3);
  background: var(--secondary);
}
.volume-container {
  display: flex;
  align-items: center;
  gap: 8px;
  justify-content: center;
}
.volume-arrow {
  background: var(--dark-3);
  border: none;
  color: var(--text);
  border-radius: 50%;
  width: 24px;
  height: 24px;
  cursor: pointer;
  font-size: 11px;
  display: flex;
  align-items: center;
  justify-content: center;
  transition: all 0.2s;
}
.volume-arrow:hover {
  background: var(--primary);
  color: var(--dark-3);
}
.volume-number {
  min-width: 25px;
  text-align: center;
  font-family: 'Antonio', sans-serif;
  font-size: 16px;
  font-weight: 500;
}

/* Clock Section */
.clock-section {
  display: flex;
  flex-direction: column;
  align-items: center;
  gap: 10px;
  min-width: 200px;
}
.clock {
  font-size: 56px;
  color: var(--text-light);
  display: flex;
  align-items: center;
  gap: 5px;
}
.timer-container {
  position: relative;
  display: flex;
  flex-direction: column;
  align-items: center;
  gap: 5px;
}
.timer-btn {
  background: var(--dark-3);
  border: none;
  color: var(--text-light);
  padding: 8px 12px;
  border-radius: 20px;
  cursor: pointer;
  font-size: 14px;
  display: flex;
  align-items: center;
  gap: 5px;
  transition: all 0.2s;
  width: 100%;
  justify-content: center;
}
.timer-btn:hover {
  background: var(--primary);
  color: white;
}
.timer-dropdown {
  position: absolute;
  top: 100%;
  background: var(--dark-3);
  border-radius: 8px;
  padding: 10px;
  box-shadow: 0 5px 15px rgba(0,0,0,0.3);
  z-index: 10;
  display: none;
  min-width: 180px;
}
.timer-dropdown.show {
  display: block;
}
.timer-option {
  padding: 8px 12px;
  border-radius: 4px;
  cursor: pointer;
  transition: background 0.2s;
}
.timer-option:hover {
  background: var(--primary);
}
.timer-display {
  font-size: 23px;
  margin-left: 5px;
  color: var(--text-light);
}
.stations-btn {
  background: var(--dark-3);
  border: none;
  color: var(--text-light);
  padding: 8px 12px;
  border-radius: 20px;
  cursor: pointer;
  font-size: 14px;
  display: flex;
  align-items: center;
  gap: 5px;
  transition: all 0.2s;
  font-family: 'Antonio', sans-serif;
  width: 100%;
  justify-content: center;
}
.stations-btn:hover {
  background: var(--primary);
  color: white;
}

/* Modal */
.modal {
  display: none;
  position: fixed;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  background-color: rgba(0, 0, 0, 0.8);
  z-index: 100;
  justify-content: center;
  align-items: center;
}
.modal-content {
  background-color: var(--dark-2);
  border-radius: 15px;
  width: 90%;
  max-width: 800px;
  max-height: 80vh;
  overflow: hidden;
  box-shadow: 0 15px 35px rgba(0, 0, 0, 0.5);
  position: relative;
  display: flex;
  flex-direction: column;
}
.modal-header {
  display: flex;
  flex-direction: column;
  padding: 25px 25px 15px 25px;
  border-bottom: 1px solid var(--dark-3);
  background-color: var(--dark-2);
  position: sticky;
  top: 0;
  z-index: 10;
  flex-shrink: 0;
}
.modal-title-container {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-bottom: 15px;
}
.modal-title {
  font-size: 24px;
  margin: 0;
  color: var(--primary);
  font-family: 'Antonio', sans-serif;
}
.close-btn {
  background: none;
  border: none;
  color: var(--text);
  font-size: 24px;
  cursor: pointer;
  transition: color 0.2s;
}
.close-btn:hover {
  color: var(--primary);
}
.modal-body {
  padding: 0 25px 25px 25px;
  overflow-y: auto;
  flex-grow: 1;
}
.stations-list {
  display: grid;
  grid-template-columns: repeat(auto-fill, minmax(180px, 1fr));
  gap: 15px;
}
.station-item {
  display: flex;
  flex-direction: column;
  align-items: center;
  background-color: var(--dark-3);
  border-radius: 10px;
  padding: 15px;
  cursor: pointer;
  transition: all 0.2s;
  width: 170px;
}
.station-item:hover {
  background-color: var(--primary);
  transform: translateY(-3px);
}
.station-logo {
  width: 60px;
  height: 60px;
  border-radius: 8px;
  background-size: cover;
  background-position: center;
  margin-bottom: 10px;
}
.station-name {
  font-size: 16px;
  text-align: center;
  margin: 0 0 5px 0;
  font-family: 'Antonio', sans-serif;
}
.station-track {
  font-size: 12px;
  color: var(--text-light);
  text-align: center;
  margin: 0;
  height: 36px;
  overflow: hidden;
  display: -webkit-box;
  -webkit-line-clamp: 2;
  -webkit-box-orient: vertical;
  font-family: 'Antonio', sans-serif;
}

/* Horari automàtic - MODAL */
.schedule-container {
  width: 100%;
  margin: 0;
  background: var(--dark-2);
  border-radius: 15px;
  padding: 15px 20px;
  box-shadow: 0 10px 25px rgba(0,0,0,0.3);
  font-family: 'Antonio', sans-serif;
}
.schedule-container table {
  width: 100%;
  border-collapse: collapse;
  color: var(--text);
  background: var(--dark-2);
  border-radius: 10px;
  overflow: hidden;
  table-layout: fixed;
  font-family: 'Antonio', sans-serif;
  font-size: 14px;
}
.schedule-container th:nth-child(1) { width: 15%; }
.schedule-container th:nth-child(2) { width: 15%; }
.schedule-container th:nth-child(3) { width: 25%; }
.schedule-container th:nth-child(4) { width: 10%; }
.schedule-container th:nth-child(5) { width: 15%; }
.schedule-container th:nth-child(6) { width: 10%; }
.schedule-container table th,
.schedule-container table td {
  border-bottom: 1px solid var(--dark-3);
  font-family: 'Antonio', sans-serif;
  padding: 8px;
}
.schedule-container table tr:last-child td {
  border-bottom: none;
}
.cancel-btn {
  background: #aa3333;
  border: none;
  color: white;
  padding: 5px 10px;
  border-radius: 12px;
  cursor: pointer;
  font-size: 12px;
  font-family: 'Antonio', sans-serif;
}
.cancel-btn:hover {
  background: #ff5555;
}
.volume-cell {
  display: flex;
  align-items: center;
  justify-content: center;
  gap: 6px;
}
.volume-number {
  min-width: 20px;
  text-align: center;
  font-family: 'Antonio', sans-serif;
}
.volume-arrow {
  background: var(--dark-3);
  border: none;
  color: var(--text);
  border-radius: 50%;
  width: 20px;
  height: 20px;
  cursor: pointer;
  font-size: 11px;
  display: flex;
  align-items: center;
  justify-content: center;
}
.volume-arrow:hover {
  background: var(--primary);
  color: var(--dark-3);
}

/* Estils per inputs i selects dins de l'horari */
.time-input, .station-select, .day-select {
  font-family: 'Antonio', sans-serif !important;
  font-size: 14px;
}

/* Check per horari actiu */
.schedule-check {
  color: var(--primary);
  margin-left: 5px;
  display: none;
}

/* Barra de cerca emissores */
.search-container {
  display: flex;
  align-items: center;
  background: var(--dark-3);
  border-radius: 20px;
  padding: 8px 15px;
  width: 100%;
  box-sizing: border-box;
}

.search-input {
  background: transparent;
  border: none;
  color: var(--text);
  font-family: 'Antonio', sans-serif;
  font-size: 14px;
  width: 100%;
  outline: none;
}

.search-input::placeholder {
  color: var(--text-light);
}

.search-icon {
  color: var(--text-light);
  margin-right: 8px;
}

.no-results {
  text-align: center;
  color: var(--text-light);
  padding: 20px;
  font-family: 'Antonio', sans-serif;
  grid-column: 1 / -1;
}

@media (max-width: 900px) {
  .player {
    flex-wrap: wrap;
    padding: 15px;
    gap: 15px;
  }
  .progress-container {
    order: 1;
    width: 100%;
    margin: 10px 0;
  }
  .controls-section, .clock-section {
    order: 2;
    min-width: auto;
    width: 100%;
    flex-direction: row;
    justify-content: center;
  }
  .clock {
    font-size: 48px;
  }
  .buttons-container {
    flex-direction: column;
    width: 100%;
  }
  .stations-list {
    grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
  }
  .station-item {
    width: 140px;
  }
  .schedule-container table {
    font-size: 12px;
  }
  .schedule-container th:nth-child(1),
  .schedule-container th:nth-child(2),
  .schedule-container th:nth-child(3),
  .schedule-container th:nth-child(4),
  .schedule-container th:nth-child(5),
  .schedule-container th:nth-child(6) {
    width: auto;
  }
}
</style>
</head>
<body>

<div class="player" id="mainPlayer">
  <div class="cover">
    <div class="disc"></div>
  </div>
  <div class="progress-container">
    <div class="progress"></div>
  </div>

  <!-- Controls Section -->
  <div class="controls-section">
    <div class="controls">
      <button class="btn prev"><i class="fas fa-backward"></i></button>
      <button class="btn play"><i class="fas fa-play"></i></button>
      <button class="btn next"><i class="fas fa-forward"></i></button>
    </div>
    <div class="volume-container">
      <button class="volume-arrow volume-down"><i class="fas fa-chevron-down"></i></button>
      <span class="volume-number">10</span>
      <button class="volume-arrow volume-up"><i class="fas fa-chevron-up"></i></button>
    </div>
  </div>

  <!-- Clock Section -->
  <div class="clock-section">
    <div class="clock" id="clock">
      <span>--:--:--</span>
    </div>
    <div class="timer-container">
      <button class="stations-btn">
        <i class="fas fa-list"></i>
        <span>Emissores</span>
      </button>
      <button class="timer-btn" style="font-family: 'Antonio', sans-serif;">
        <i class="fas fa-hourglass-half"></i>
        <span class="timer-display">OFF</span>
      </button>
      <div class="timer-dropdown">
        <div class="timer-option" data-minutes="5">5 minuts</div>
        <div class="timer-option" data-minutes="15">15 minuts</div>
        <div class="timer-option" data-minutes="30">30 minuts</div>
        <div class="timer-option" data-minutes="60">1 hora</div>
        <div class="timer-option" data-minutes="0">Desactivar</div>
      </div>
    </div>
  </div>

  <div class="info">
    <h3 class="title" id="title">Carregant...</h3>
    <p class="artist" id="artist">Ràdio en Directe</p>
  </div>
</div>

<!-- Botons Nou Player i Horari automàtic junts -->
<div class="buttons-container">
  <button class="add-player-btn" id="addPlayerBtn">
    <i class="fas fa-plus"></i>
    <span>Nou Player</span>
  </button>

  <button class="add-player-btn" id="openScheduleModalBtn">
    <i class="fas fa-clock"></i>
    <span>Horari automàtic</span>
    <span class="schedule-check" id="scheduleCheck">
      <i class="fas fa-check"></i>
    </span>
  </button>
</div>

<!-- Modal Horari automàtic -->
<div class="modal" id="scheduleModal">
  <div class="modal-content">
    <div class="modal-header">
      <div class="modal-title-container">
        <h2 class="modal-title">Horari automàtic</h2>
        <button class="close-btn" id="closeScheduleModal">&times;</button>
      </div>
    </div>
    <div class="modal-body">
      <div class="schedule-container">
        <table id="scheduleTable">
          <thead style="background: var(--dark-3);">
            <tr>
              <th>Dia</th>
              <th>Hora (HH:MM)</th>
              <th>Emissora</th>
              <th>Actiu</th>
              <th>Volum (0-10)</th>
              <th>Cancel·lar</th>
            </tr>
          </thead>
          <tbody id="scheduleBody">
            <!-- Files generades automàticament des del JavaScript -->
          </tbody>
        </table>
        <button id="addScheduleRow" class="add-player-btn" style="margin-top:10px;">
          <i class="fas fa-plus"></i> Afegir fila
        </button>
      </div>
    </div>
  </div>
</div>

<!-- Modal emissores -->
<div class="modal" id="stationsModal">
  <div class="modal-content">
    <div class="modal-header">
      <div class="modal-title-container">
        <h2 class="modal-title">Totes les emissores</h2>
        <button class="close-btn" id="closeModal">&times;</button>
      </div>
      <div class="search-container">
        <i class="fas fa-search search-icon"></i>
        <input type="text" class="search-input" id="stationSearch" placeholder="Cerca emissores...">
      </div>
    </div>
    <div class="modal-body">
      <div class="stations-list" id="stationsList">
        <!-- Emissores dinàmiques -->
      </div>
    </div>
  </div>
</div>

<script>
// Rellotge
function updateClock() {
  const now = new Date();
  const timeString = now.toLocaleTimeString('ca-ES', {hour12: false});
  document.getElementById('clock').querySelector('span').textContent = timeString;
}
setInterval(updateClock, 1000);
updateClock();

// Variables globals
let stations = [];
let modalUpdateInterval = null;
let activePlayer = null;

// CONFIGURACIÓ DE L'HORARI AUTOMÀTIC (JSON)
const scheduleConfig = {
  defaultRows: [
    {
      day: 3,           // Dimarts (0=Diumenge, 1=Dilluns, 2=Dimarts, etc.)
      time: "06:45",    // Hora
      stationIndex: 0,  // Índex de l'emissora (0=primera, 1=segona, 2=tercera, etc.)
      active: true,     // Activat per defecte
      volume: 10        // Volum (0-10)
    },
    {
      day: 2,           // Dimarts
      time: "20:00",    // Hora
      stationIndex: 7,  // TERCERA emissora (índex 2)
      active: true,
      volume: 10
    }
  ],
  newRowDefaults: {
    day: 7,            // Tots els dies per defecte en files noves
    time: "12:00",     // Hora per defecte
    stationIndex: 0,   // Primera emissora per defecte
    active: false,     // No activat per defecte
    volume: 10         // Volum per defecte
  }
};

// Funció per comprovar si hi ha horaris actius
function checkActiveSchedules() {
  const checkboxes = document.querySelectorAll('.active-checkbox');
  let hasActive = false;

  checkboxes.forEach(checkbox => {
    if (checkbox.checked) {
      hasActive = true;
    }
  });

  const scheduleCheck = document.getElementById('scheduleCheck');
  if (hasActive) {
    scheduleCheck.style.display = 'inline';
  } else {
    scheduleCheck.style.display = 'none';
  }
}

// Funció per filtrar emissores
function filterStations() {
  const searchTerm = document.getElementById('stationSearch').value.toLowerCase();
  const stationItems = document.querySelectorAll('.station-item');
  let hasVisibleItems = false;

  stationItems.forEach(item => {
    const stationName = item.querySelector('.station-name').textContent.toLowerCase();
    const stationTrack = item.querySelector('.station-track').textContent.toLowerCase();

    if (stationName.includes(searchTerm) || stationTrack.includes(searchTerm)) {
      item.style.display = 'flex';
      hasVisibleItems = true;
    } else {
      item.style.display = 'none';
    }
  });

  // Mostrar missatge si no hi ha resultats
  let noResultsMsg = document.getElementById('noResultsMessage');
  if (!hasVisibleItems) {
    if (!noResultsMsg) {
      noResultsMsg = document.createElement('div');
      noResultsMsg.id = 'noResultsMessage';
      noResultsMsg.className = 'no-results';
      noResultsMsg.textContent = 'No s\'han trobat emissores';
      document.getElementById('stationsList').appendChild(noResultsMsg);
    }
  } else if (noResultsMsg) {
    noResultsMsg.remove();
  }
}

// Actualitzar info pistes al modal
async function updateModalTracks() {
  for (let i = 0; i < stations.length; i++) {
    const station = stations[i];
    if (station.playlist) {
      try {
        const response = await fetch(station.playlist);
        const data = await response.json();
        if (data.success && data.result && data.result.length > 0) {
          const currentTrack = data.result[0];
          const trackElement = document.getElementById(`station-track-${i}`);
          if (trackElement) {
            if (currentTrack.track_artist && currentTrack.track_title) {
              trackElement.textContent = `${currentTrack.track_artist} - ${currentTrack.track_title}`;
            } else if (currentTrack.track_artist) {
              trackElement.textContent = currentTrack.track_artist;
            } else if (currentTrack.track_title) {
              trackElement.textContent = currentTrack.track_title;
            } else {
              trackElement.textContent = "Ràdio en Directe";
            }
          }
        }
      } catch (error) {
        console.error(`Error obtenint informació per ${station.name}:`, error);
        const trackElement = document.getElementById(`station-track-${i}`);
        if (trackElement) {
          trackElement.textContent = "Ràdio en Directe";
        }
      }
    }
  }
}

// Llista d'emissores al modal
function populateStationsList() {
  const stationsList = document.getElementById('stationsList');
  stationsList.innerHTML = '';
  stations.forEach((station, index) => {
    const stationItem = document.createElement('div');
    stationItem.className = 'station-item';
    stationItem.innerHTML = `
      <div class="station-logo" style="background-image: url('${station.logo}')"></div>
      <h3 class="station-name">${station.name}</h3>
      <p class="station-track" id="station-track-${index}">Ràdio en Directe</p>
    `;
    stationItem.addEventListener('click', () => {
      if (activePlayer) {
        activePlayer.currentStationIndex = index;
        activePlayer.loadStation(station);
      }
      stationsModal.style.display = 'none';
      if (modalUpdateInterval) {
        clearInterval(modalUpdateInterval);
        modalUpdateInterval = null;
      }
    });
    stationsList.appendChild(stationItem);
  });
}

// Modal emissores
const stationsModal = document.getElementById('stationsModal');
const closeModalBtn = document.getElementById('closeModal');

closeModalBtn.addEventListener('click', () => {
  stationsModal.style.display = 'none';
  if (modalUpdateInterval) {
    clearInterval(modalUpdateInterval);
    modalUpdateInterval = null;
  }
});

window.addEventListener('click', (e) => {
  if (e.target === stationsModal) {
    stationsModal.style.display = 'none';
    if (modalUpdateInterval) {
      clearInterval(modalUpdateInterval);
      modalUpdateInterval = null;
    }
  }
});

// Modal horari automàtic
const scheduleModal = document.getElementById('scheduleModal');
const openScheduleModalBtn = document.getElementById('openScheduleModalBtn');
const closeScheduleModalBtn = document.getElementById('closeScheduleModal');

openScheduleModalBtn.addEventListener('click', () => {
  scheduleModal.style.display = 'flex';
});

closeScheduleModalBtn.addEventListener('click', () => {
  scheduleModal.style.display = 'none';
});

window.addEventListener('click', (e) => {
  if (e.target === scheduleModal) {
    scheduleModal.style.display = 'none';
  }
});

// Classe RadioPlayer
class RadioPlayer {
  constructor(playerElement, isMain = false) {
    this.playerElement = playerElement;
    this.isMain = isMain;
    this.audio = new Audio();
    this.currentStationIndex = 0;
    this.isPlaying = false;
    this.sleepTimer = null;
    this.remainingTime = 0;
    this.playlistInterval = null;

    this.playBtn = this.playerElement.querySelector('.play');
    this.prevBtn = this.playerElement.querySelector('.prev');
    this.nextBtn = this.playerElement.querySelector('.next');
    this.disc = this.playerElement.querySelector('.disc');
    this.title = this.playerElement.querySelector('.title');
    this.artist = this.playerElement.querySelector('.artist');
    this.volumeDownBtn = this.playerElement.querySelector('.volume-down');
    this.volumeUpBtn = this.playerElement.querySelector('.volume-up');
    this.volumeNumber = this.playerElement.querySelector('.volume-number');
    this.closeBtn = this.playerElement.querySelector('.close-player');
    this.stationsBtn = this.playerElement.querySelector('.stations-btn');
    this.timerBtn = this.playerElement.querySelector('.timer-btn');
    this.timerDisplay = this.playerElement.querySelector('.timer-display');
    this.timerDropdown = this.playerElement.querySelector('.timer-dropdown');

    this.initEvents();
  }

  initEvents() {
    this.volumeDownBtn.addEventListener('click', () => this.changeVolume(-1));
    this.volumeUpBtn.addEventListener('click', () => this.changeVolume(1));

    this.timerBtn.addEventListener('click', (e) => {
      e.stopPropagation();
      this.timerDropdown.classList.toggle('show');
    });

    this.playerElement.querySelectorAll('.timer-option').forEach(option => {
      option.addEventListener('click', (e) => {
        const minutes = parseInt(e.target.dataset.minutes);
        this.setSleepTimer(minutes);
        this.timerDropdown.classList.remove('show');
      });
    });

    this.playBtn.addEventListener('click', () => this.togglePlay());
    this.prevBtn.addEventListener('click', () => this.prevStation());
    this.nextBtn.addEventListener('click', () => this.nextStation());

    if (this.closeBtn) {
      this.closeBtn.addEventListener('click', () => {
        this.audio.pause();
        this.playerElement.remove();
      });
    }

    this.stationsBtn.addEventListener('click', () => {
      activePlayer = this;
      stationsModal.style.display = 'flex';
      updateModalTracks();
      if (modalUpdateInterval) {
        clearInterval(modalUpdateInterval);
      }
      modalUpdateInterval = setInterval(updateModalTracks, 20000);

      // Netejar el camp de cerca quan s'obri el modal
      document.getElementById('stationSearch').value = '';
      filterStations();
    });
  }

  changeVolume(delta) {
    let currentVolume = parseInt(this.volumeNumber.textContent, 10);
    let newVolume = currentVolume + delta;

    if (newVolume < 0) newVolume = 0;
    if (newVolume > 10) newVolume = 10;

    this.volumeNumber.textContent = newVolume;
    this.audio.volume = newVolume / 10;
  }

  setSleepTimer(minutes) {
    if (this.sleepTimer) {
      clearInterval(this.sleepTimer);
      this.sleepTimer = null;
    }
    if (minutes === 0) {
      this.timerDisplay.textContent = 'OFF';
      this.remainingTime = 0;
      return;
    }
    this.remainingTime = minutes * 60;
    this.updateTimerDisplay();
    this.sleepTimer = setInterval(() => {
      this.remainingTime--;
      this.updateTimerDisplay();
      if (this.remainingTime <= 0) {
        clearInterval(this.sleepTimer);
        this.sleepTimer = null;
        if (this.isPlaying) {
          this.togglePlay();
        }
        this.timerDisplay.textContent = 'OFF';
      }
    }, 1000);
  }

  updateTimerDisplay() {
    const hours = Math.floor(this.remainingTime / 3600);
    const minutes = Math.floor((this.remainingTime % 3600) / 60);
    const seconds = this.remainingTime % 60;
    this.timerDisplay.textContent =
      `${hours.toString().padStart(2, '0')}:` +
      `${minutes.toString().padStart(2, '0')}:` +
      `${seconds.toString().padStart(2, '0')}`;
  }

  loadStation(station) {
    this.title.textContent = station.name;
    this.artist.textContent = "Carregant informació...";
    this.audio.src = station.url;
    this.disc.style.backgroundImage = `url('${station.logo}')`;
    this.audio.volume = parseInt(this.volumeNumber.textContent, 10) / 10;
    if (station.playlist) {
      this.startPlaylistUpdates(station.playlist);
    } else {
      this.artist.textContent = "Ràdio en Directe";
      if (this.playlistInterval) {
        clearInterval(this.playlistInterval);
        this.playlistInterval = null;
      }
    }
    if (this.isPlaying) this.audio.play().catch(() => {});
  }

  async updatePlaylistInfo(playlistUrl) {
    try {
      const response = await fetch(playlistUrl);
      const data = await response.json();
      if (data.success && data.result && data.result.length > 0) {
        const currentTrack = data.result[0];
        if (currentTrack.track_artist && currentTrack.track_title) {
          this.artist.textContent = `${currentTrack.track_artist} - ${currentTrack.track_title}`;
        } else if (currentTrack.track_artist) {
          this.artist.textContent = currentTrack.track_artist;
        } else if (currentTrack.track_title) {
          this.artist.textContent = currentTrack.track_title;
        } else {
          this.artist.textContent = "Ràdio en Directe";
        }
        if (currentTrack.track_image) {
          this.disc.style.backgroundImage = `url('${currentTrack.track_image}')`;
        }
      } else {
        this.artist.textContent = "Ràdio en Directe";
      }
    } catch (error) {
      console.error("Error obtenint informació de la playlist:", error);
      this.artist.textContent = "Ràdio en Directe";
      setTimeout(() => {
        if (this.playlistInterval) {
          this.updatePlaylistInfo(playlistUrl);
        }
      }, 5000);
    }
  }

  startPlaylistUpdates(playlistUrl) {
    if (this.playlistInterval) {
      clearInterval(this.playlistInterval);
    }
    this.updatePlaylistInfo(playlistUrl);
    this.playlistInterval = setInterval(() => {
      this.updatePlaylistInfo(playlistUrl);
    }, 10000);
  }

  togglePlay() {
    if (this.isPlaying) {
      this.audio.pause();
      this.playBtn.innerHTML = '<i class="fas fa-play"></i>';
      this.disc.style.animationPlayState = 'paused';
    } else {
      this.audio.play().catch(e => {
        console.warn('No s\'ha pogut iniciar la reproducció:', e);
      });
      this.playBtn.innerHTML = '<i class="fas fa-pause"></i>';
      this.disc.style.animationPlayState = 'running';
    }
    this.isPlaying = !this.isPlaying;
  }

  prevStation() {
    if (stations.length === 0) return;
    this.currentStationIndex = (this.currentStationIndex - 1 + stations.length) % stations.length;
    this.loadStation(stations[this.currentStationIndex]);
  }

  nextStation() {
    if (stations.length === 0) return;
    this.currentStationIndex = (this.currentStationIndex + 1) % stations.length;
    this.loadStation(stations[this.currentStationIndex]);
  }
}

// Funció per generar les files inicials des del JSON
function generateInitialScheduleRows() {
  const scheduleBody = document.getElementById('scheduleBody');
  scheduleBody.innerHTML = ''; // Netejar

  scheduleConfig.defaultRows.forEach(rowConfig => {
    const row = createScheduleRow(rowConfig);
    scheduleBody.appendChild(row);
  });
}

// Funció per crear una fila d'horari
function createScheduleRow(config = null) {
  const row = document.createElement('tr');

  // Si no hi ha configuració, usa els valors per defecte per noves files
  const defaults = config || scheduleConfig.newRowDefaults;

  row.innerHTML = `
    <td>
      <select class="day-select" style="background: var(--dark-3); color: var(--text); border: none; padding: 5px; border-radius: 5px; width: 100%;">
        <option value="0" ${defaults.day === 0 ? 'selected' : ''}>Diumenge</option>
        <option value="1" ${defaults.day === 1 ? 'selected' : ''}>Dilluns</option>
        <option value="2" ${defaults.day === 2 ? 'selected' : ''}>Dimarts</option>
        <option value="3" ${defaults.day === 3 ? 'selected' : ''}>Dimecres</option>
        <option value="4" ${defaults.day === 4 ? 'selected' : ''}>Dijous</option>
        <option value="5" ${defaults.day === 5 ? 'selected' : ''}>Divendres</option>
        <option value="6" ${defaults.day === 6 ? 'selected' : ''}>Dissabte</option>
        <option value="7" ${defaults.day === 7 ? 'selected' : ''}>Tots els dies</option>
      </select>
    </td>
    <td>
      <input type="time" class="time-input" value="${defaults.time}"
             style="background: var(--dark-3); color: var(--text); border: none; padding: 5px; border-radius: 5px; width: 100%;">
    </td>
    <td>
      <select class="station-select"
              style="background: var(--dark-3); color: var(--text); border:none; padding:5px; border-radius:5px; width:100%;">
        <option value="">-- Selecciona emissora --</option>
      </select>
    </td>
    <td style="text-align:center;">
      <input type="checkbox" class="active-checkbox" ${defaults.active ? 'checked' : ''}>
    </td>
    <td style="text-align:center;">
      <div class="volume-cell">
        <button class="volume-arrow volume-down">-</button>
        <span class="volume-number">${defaults.volume}</span>
        <button class="volume-arrow volume-up">+</button>
      </div>
    </td>
    <td style="text-align:center;">
      <button class="cancel-btn">X</button>
    </td>
  `;

  return row;
}

// Carregar emissores
async function loadStations() {
  try {
    const response = await fetch('https://xarxa-1.github.io/Xarxa-1/emissores.json');
    stations = await response.json();
    if (stations.length > 0) {
      mainPlayer.loadStation(stations[mainPlayer.currentStationIndex]);
      populateStationsList();
      populateStationOptions();

      // Configurar files per defecte DES DEL JSON
      const selects = document.querySelectorAll('.station-select');

      scheduleConfig.defaultRows.forEach((rowConfig, index) => {
        if (selects[index] && rowConfig.stationIndex < stations.length) {
          selects[index].value = rowConfig.stationIndex.toString();
        }
      });

      // Comprovar horaris actius inicialment
      checkActiveSchedules();
    }
  } catch (error) {
    console.error("Error carregant estacions:", error);
  }
}

// Reproductor principal
const mainPlayerElement = document.getElementById('mainPlayer');
const mainPlayer = new RadioPlayer(mainPlayerElement, true);
activePlayer = mainPlayer;

// Inicialitzar les files de l'horari
generateInitialScheduleRows();

// Afegir nous reproductors
const addPlayerBtn = document.getElementById('addPlayerBtn');
let playerCounter = 0;

addPlayerBtn.addEventListener('click', () => {
  createNewPlayer();
});

function createNewPlayer() {
  playerCounter++;
  const newPlayer = document.createElement('div');
  newPlayer.className = 'player';
  newPlayer.id = `player-${playerCounter}`;

  newPlayer.innerHTML = `
    <button class="close-player">&times;</button>
    <div class="cover">
      <div class="disc"></div>
    </div>
    <div class="progress-container">
      <div class="progress"></div>
    </div>

    <!-- Controls Section -->
    <div class="controls-section">
      <div class="controls">
        <button class="btn prev"><i class="fas fa-backward"></i></button>
        <button class="btn play"><i class="fas fa-play"></i></button>
        <button class="btn next"><i class="fas fa-forward"></i></button>
      </div>
      <div class="volume-container">
        <button class="volume-arrow volume-down"><i class="fas fa-chevron-down"></i></button>
        <span class="volume-number">10</span>
        <button class="volume-arrow volume-up"><i class="fas fa-chevron-up"></i></button>
      </div>
    </div>

    <!-- Clock Section -->
    <div class="clock-section">
      <div class="clock">
        <span>--:--:--</span>
      </div>
      <div class="timer-container">
        <button class="stations-btn">
          <i class="fas fa-list"></i>
          <span>Emissores</span>
        </button>
        <button class="timer-btn" style="font-family: 'Antonio', sans-serif;">
          <i class="fas fa-hourglass-half"></i>
          <span class="timer-display">OFF</span>
        </button>
        <div class="timer-dropdown">
          <div class="timer-option" data-minutes="5">5 minuts</div>
          <div class="timer-option" data-minutes="15">15 minuts</div>
          <div class="timer-option" data-minutes="30">30 minuts</div>
          <div class="timer-option" data-minutes="60">1 hora</div>
          <div class="timer-option" data-minutes="0">Desactivar</div>
        </div>
      </div>
    </div>

    <div class="info">
      <h3 class="title">Carregant...</h3>
      <p class="artist">Ràdio en Directe</p>
    </div>
  `;

  document.body.insertBefore(newPlayer, document.querySelector('.buttons-container'));

  const newRadioPlayer = new RadioPlayer(newPlayer);
  if (stations.length > 0) {
    newRadioPlayer.loadStation(stations[newRadioPlayer.currentStationIndex]);
  }
}

// Horari automàtic
const scheduleBody = document.getElementById('scheduleBody');
const addScheduleRowBtn = document.getElementById('addScheduleRow');

// Omplir select d'emissores
function populateStationOptions() {
  const selects = document.querySelectorAll('.station-select');
  selects.forEach((select, selectIndex) => {
    const currentValue = select.value;
    select.innerHTML = '<option value="">-- Selecciona emissora --</option>';

    stations.forEach((station, stationIndex) => {
      const opt = document.createElement('option');
      opt.value = stationIndex;
      opt.textContent = station.name;
      select.appendChild(opt);
    });

    // Si és una fila inicial i encara no té valor, assigna'l del JSON
    if (!currentValue && selectIndex < scheduleConfig.defaultRows.length) {
      const rowConfig = scheduleConfig.defaultRows[selectIndex];
      if (rowConfig && rowConfig.stationIndex < stations.length) {
        select.value = rowConfig.stationIndex.toString();
      }
    } else if (currentValue !== "") {
      select.value = currentValue;
    }
  });
}

// Afegir fila
addScheduleRowBtn.addEventListener('click', () => {
  const newRow = createScheduleRow(); // Usa newRowDefaults del JSON
  scheduleBody.appendChild(newRow);
  populateStationOptions();

  // Afegir event listener al nou checkbox
  const newCheckbox = newRow.querySelector('.active-checkbox');
  newCheckbox.addEventListener('change', checkActiveSchedules);

  // Comprovar horaris actius després d'afegir la fila
  checkActiveSchedules();
});

// Delegació per al botó Cancel·lar i volum +/-
scheduleBody.addEventListener('click', (e) => {
  if (e.target.classList.contains('cancel-btn')) {
    const row = e.target.closest('tr');
    if (row) row.remove();

    // Comprovar horaris actius després d'eliminar una fila
    checkActiveSchedules();
  }

  if (e.target.classList.contains('volume-up') || e.target.classList.contains('volume-down')) {
    const cell = e.target.closest('.volume-cell');
    if (!cell) return;
    const span = cell.querySelector('.volume-number');
    let value = parseInt(span.textContent, 10) || 0;
    if (e.target.classList.contains('volume-up')) {
      value = Math.min(10, value + 1);
    } else {
      value = Math.max(0, value - 1);
    }
    span.textContent = value.toString();
  }
});

// Afegir event listeners als checkboxes existents
document.addEventListener('DOMContentLoaded', function() {
  // Comprovar horaris actius quan es carrega la pàgina
  checkActiveSchedules();

  // Afegir event listener als checkboxes existents
  document.querySelectorAll('.active-checkbox').forEach(checkbox => {
    checkbox.addEventListener('change', checkActiveSchedules);
  });

  // Afegir event listener al camp de cerca d'emissores
  document.getElementById('stationSearch').addEventListener('input', filterStations);
});

// Funció per obtenir el nom del dia a partir del valor numèric
function getDayName(dayValue) {
  const days = {
    '0': 'Diumenge',
    '1': 'Dilluns',
    '2': 'Dimarts',
    '3': 'Dimecres',
    '4': 'Dijous',
    '5': 'Divendres',
    '6': 'Dissabte',
    '7': 'Tots els dies'
  };
  return days[dayValue] || 'Desconegut';
}

// Funció per mostrar el dia actual en cada fila
function updateScheduleDayDisplay() {
  const rows = document.querySelectorAll('#scheduleBody tr');
  const now = new Date();
  const currentDay = now.getDay(); // 0=diumenge, 1=dilluns, ..., 6=dissabte

  rows.forEach(row => {
    const daySelect = row.querySelector('.day-select');
    const dayValue = daySelect ? parseInt(daySelect.value, 10) : null;

    if (dayValue !== null) {
      const dayName = getDayName(dayValue.toString());

      // Crear o actualitzar el display del dia
      let dayDisplay = row.querySelector('.day-display');
      if (!dayDisplay) {
        dayDisplay = document.createElement('div');
        dayDisplay.className = 'day-display';
        dayDisplay.style.fontSize = '12px';
        dayDisplay.style.color = 'var(--text-light)';
        dayDisplay.style.marginTop = '3px';
        daySelect.parentNode.appendChild(dayDisplay);
      }

      // Mostrar si és avui
      const isToday = (dayValue === 7) || (dayValue === currentDay);
      if (isToday) {
        dayDisplay.textContent = `${dayName} (avui)`;
        dayDisplay.style.color = 'var(--primary)';
      } else {
        dayDisplay.textContent = dayName;
        dayDisplay.style.color = 'var(--text-light)';
      }
    }
  });
}

// Comprovació d'horaris: només al segon 00
function checkSchedule() {
  const now = new Date();
  const currentDay = now.getDay(); // 0=diumenge, 1=dilluns, ..., 6=dissabte
  const hours = now.getHours().toString().padStart(2, '0');
  const minutes = now.getMinutes().toString().padStart(2, '0');
  const seconds = now.getSeconds().toString().padStart(2, '0');

  if (seconds !== '00') return; // només quan el segon és 00

  const currentTime = `${hours}:${minutes}`; // HH:MM
  const rows = document.querySelectorAll('#scheduleBody tr');

  rows.forEach(row => {
    const daySelect = row.querySelector('.day-select');
    const timeInput = row.querySelector('.time-input');
    const select = row.querySelector('.station-select');
    const active = row.querySelector('.active-checkbox')?.checked;
    const volumeSpan = row.querySelector('.volume-number');

    if (!active || !timeInput.value || !select.value) return;

    // Comprovar el dia
    const selectedDay = parseInt(daySelect.value, 10);
    const isDayMatch = selectedDay === 7 || selectedDay === currentDay;

    if (isDayMatch && timeInput.value === currentTime) {
      const index = parseInt(select.value, 10);
      if (stations[index] && mainPlayer) {
        const wasPlaying = mainPlayer.isPlaying;
        mainPlayer.currentStationIndex = index;
        mainPlayer.loadStation(stations[index]);

        // Aplicar volum de la fila (0-10 -> 0.0-1.0)
        let vol = parseInt(volumeSpan?.textContent || '10', 10);
        if (Number.isNaN(vol)) vol = 10;
        vol = Math.min(10, Math.max(0, vol));
        const volNorm = vol / 10;
        mainPlayer.audio.volume = volNorm;
        mainPlayer.volumeNumber.textContent = vol.toString();

        if (wasPlaying) {
          mainPlayer.audio.play().catch(e => {
            console.warn('No s\'ha pogut reprendre la reproducció:', e);
          });
        }
      }
    }
  });

  // Actualitzar la visualització del dia
  updateScheduleDayDisplay();
}

// Comprovar cada segon, però la funció només actua al segon 00
setInterval(checkSchedule, 1000);

// Actualitzar la visualització del dia quan s'obri el modal
openScheduleModalBtn.addEventListener('click', () => {
  // Esperar un moment perquè el modal es mostri
  setTimeout(updateScheduleDayDisplay, 100);
});

// Actualitzar la visualització del dia quan es canvia el dia
scheduleBody.addEventListener('change', (e) => {
  if (e.target.classList.contains('day-select')) {
    updateScheduleDayDisplay();
  }
});

// Iniciar càrrega emissores
loadStations();

// Actualitzar la visualització del dia inicialment
setTimeout(updateScheduleDayDisplay, 500);
</script>
</body>
</html>