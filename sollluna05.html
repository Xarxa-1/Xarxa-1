<!DOCTYPE html>
<html lang="ca">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>Vista AR - Sol i Lluna amb Hores</title>
    <style>
        body {
            margin: 0;
            padding: 0;
            font-family: Arial, sans-serif;
            overflow: hidden;
            background-color: #000;
            color: white;
        }
        
        #ar-container {
            position: relative;
            width: 100vw;
            height: 100vh;
            overflow: hidden;
        }
        
        #video-container {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: 1;
        }
        
        #video {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }
        
        #overlay {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: 2;
            pointer-events: none;
        }
        
        .celestial-body {
            position: absolute;
            border-radius: 50%;
            transform: translate(-50%, -50%);
            box-shadow: 0 0 15px rgba(255, 255, 255, 0.7);
            z-index: 3;
        }
        
        #sun {
            background: radial-gradient(circle at 30% 30%, #FFF9C4, #FFEB3B, #FF9800);
            width: 50px;
            height: 50px;
        }
        
        #moon {
            background: radial-gradient(circle at 30% 30%, #FFFFFF, #E0E0E0, #9E9E9E);
            width: 40px;
            height: 40px;
        }
        
        #trajectories {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: 2;
        }
        
        .time-marker {
            position: absolute;
            color: white;
            font-size: 12px;
            background-color: rgba(0, 0, 0, 0.5);
            padding: 2px 5px;
            border-radius: 3px;
            transform: translate(-50%, -50%);
            z-index: 4;
        }
        
        .sun-time {
            color: #FFD700;
        }
        
        .moon-time {
            color: #E6E6FA;
        }
        
        #controls {
            position: absolute;
            bottom: 20px;
            left: 0;
            width: 100%;
            display: flex;
            justify-content: center;
            z-index: 10;
            pointer-events: auto;
        }
        
        button {
            background-color: rgba(0, 0, 0, 0.7);
            color: white;
            border: 1px solid white;
            border-radius: 20px;
            padding: 10px 20px;
            margin: 0 10px;
            font-size: 16px;
            cursor: pointer;
        }
        
        #info-panel {
            position: absolute;
            top: 20px;
            left: 20px;
            background-color: rgba(0, 0, 0, 0.7);
            padding: 15px;
            border-radius: 10px;
            max-width: 300px;
            z-index: 10;
        }
        
        #loading {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.8);
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            z-index: 100;
        }
        
        .hidden {
            display: none !important;
        }
    </style>
</head>
<body>
    <div id="ar-container">
        <div id="video-container">
            <video id="video" autoplay playsinline></video>
        </div>
        
        <div id="overlay">
            <svg id="trajectories" xmlns="http://www.w3.org/2000/svg"></svg>
            <div id="sun" class="celestial-body"></div>
            <div id="moon" class="celestial-body"></div>
            <!-- Marcadores de tiempo se añadirán dinámicamente -->
        </div>
        
        <div id="info-panel">
            <h3>Vista AR - Sol i Lluna</h3>
            <p><strong>Sol:</strong> <span id="sun-azimuth">0</span>° azimut, <span id="sun-altitude">0</span>° altura</p>
            <p><strong>Lluna:</strong> <span id="moon-azimuth">0</span>° azimut, <span id="moon-altitude">0</span>° altura</p>
            <p><strong>Orientació:</strong> <span id="device-alpha">0</span>°</p>
            <p><strong>Hora actual:</strong> <span id="current-time">00:00</span></p>
        </div>
        
        <div id="controls">
            <button id="switch-camera">Canviar Càmera</button>
            <button id="toggle-trajectories">Mostrar/Ocultar Trajectòries</button>
            <button id="toggle-time-markers">Mostrar/Ocultar Hores</button>
        </div>
        
        <div id="loading">
            <h2>Carregant Vista AR</h2>
            <p>Esperant permisos de càmera i sensors...</p>
            <button id="start-ar">Activar AR</button>
        </div>
    </div>

    <script>
        // Variables globals
        let video = document.getElementById('video');
        let sun = document.getElementById('sun');
        let moon = document.getElementById('moon');
        let trajectories = document.getElementById('trajectories');
        let showTrajectories = true;
        let showTimeMarkers = true;
        let currentFacingMode = 'environment';
        let deviceOrientation = { alpha: 0, beta: 0, gamma: 0 };
        let sunPosition = { azimuth: 0, altitude: 0 };
        let moonPosition = { azimuth: 0, altitude: 0 };
        let sunTimeMarkers = [];
        let moonTimeMarkers = [];
        
        // Elements d'informació
        const sunAzimuthElement = document.getElementById('sun-azimuth');
        const sunAltitudeElement = document.getElementById('sun-altitude');
        const moonAzimuthElement = document.getElementById('moon-azimuth');
        const moonAltitudeElement = document.getElementById('moon-altitude');
        const deviceAlphaElement = document.getElementById('device-alpha');
        const currentTimeElement = document.getElementById('current-time');
        
        // Botons
        const switchCameraBtn = document.getElementById('switch-camera');
        const toggleTrajectoriesBtn = document.getElementById('toggle-trajectories');
        const toggleTimeMarkersBtn = document.getElementById('toggle-time-markers');
        const startARBtn = document.getElementById('start-ar');
        
        // Inicialització
        document.addEventListener('DOMContentLoaded', () => {
            startARBtn.addEventListener('click', initAR);
            switchCameraBtn.addEventListener('click', switchCamera);
            toggleTrajectoriesBtn.addEventListener('click', toggleTrajectories);
            toggleTimeMarkersBtn.addEventListener('click', toggleTimeMarkers);
            
            // Actualitzar hora actual cada minut
            updateCurrentTime();
            setInterval(updateCurrentTime, 60000);
        });
        
        // Funció per iniciar l'AR
        async function initAR() {
            try {
                // Demanar permisos de càmera
                const stream = await navigator.mediaDevices.getUserMedia({
                    video: { 
                        facingMode: currentFacingMode,
                        width: { ideal: 1920 },
                        height: { ideal: 1080 }
                    },
                    audio: false
                });
                
                video.srcObject = stream;
                
                // Configurar els sensors d'orientació
                if (window.DeviceOrientationEvent) {
                    window.addEventListener('deviceorientation', handleOrientation);
                } else {
                    alert("El vostre navegador no suporta l'API DeviceOrientation");
                }
                
                // Amagar pantalla de càrrega
                document.getElementById('loading').classList.add('hidden');
                
                // Iniciar bucle de renderització
                requestAnimationFrame(updatePositions);
            } catch (error) {
                console.error("Error en inicialitzar AR:", error);
                alert("No s'ha pogut accedir a la càmera: " + error.message);
            }
        }
        
        // Actualitzar l'hora actual
        function updateCurrentTime() {
            const now = new Date();
            const hours = now.getHours().toString().padStart(2, '0');
            const minutes = now.getMinutes().toString().padStart(2, '0');
            currentTimeElement.textContent = `${hours}:${minutes}`;
        }
        
        // Manejar l'orientació del dispositiu
        function handleOrientation(event) {
            deviceOrientation = {
                alpha: event.alpha,  // Rotació respecte al nord (0-360)
                beta: event.beta,    // Inclinació front-back (-180 a 180)
                gamma: event.gamma   // Inclinació esquerra-dreta (-90 a 90)
            };
            
            deviceAlphaElement.textContent = Math.round(deviceOrientation.alpha);
        }
        
        // Actualitzar posicions dels elements AR
        function updatePositions() {
            const now = new Date();
            const lat = 41.3851;  // Barcelona per defecte (canviar segons localització)
            const lng = 2.1734;
            
            // Calcular posició del sol (simplificat)
            const sunPos = calculateSunPosition(now, lat, lng);
            sunPosition.azimuth = sunPos.azimuth;
            sunPosition.altitude = sunPos.altitude;
            
            // Calcular posició de la lluna (simplificat)
            const moonPos = calculateMoonPosition(now, lat, lng);
            moonPosition.azimuth = moonPos.azimuth;
            moonPosition.altitude = moonPos.altitude;
            
            // Actualitzar UI
            updateCelestialBodyPosition(sun, sunPosition);
            updateCelestialBodyPosition(moon, moonPosition);
            
            // Actualitzar informació
            sunAzimuthElement.textContent = Math.round(sunPosition.azimuth);
            sunAltitudeElement.textContent = Math.round(sunPosition.altitude);
            moonAzimuthElement.textContent = Math.round(moonPosition.azimuth);
            moonAltitudeElement.textContent = Math.round(moonPosition.altitude);
            
            // Actualitzar trajectòries i marcadors de temps si estan activats
            if (showTrajectories) {
                updateTrajectories(now, lat, lng);
            }
            
            if (showTimeMarkers) {
                updateTimeMarkers(now, lat, lng);
            }
            
            // Continuar el bucle
            requestAnimationFrame(updatePositions);
        }
        
        // Actualitzar posició d'un cos celeste
        function updateCelestialBodyPosition(element, position) {
            const viewWidth = window.innerWidth;
            const viewHeight = window.innerHeight;
            
            // Convertir azimut i altura a coordenades de pantalla
            const azimuthRad = (position.azimuth - deviceOrientation.alpha) * Math.PI / 180;
            const altitudeRad = position.altitude * Math.PI / 180;
            
            // Coordenades 3D (simplificat)
            const distance = 100;  // Distància fictícia per a la projecció
            const x = distance * Math.sin(azimuthRad) * Math.cos(altitudeRad);
            const y = distance * Math.sin(altitudeRad);
            
            // Projectar a 2D
            const screenX = (x + distance) * viewWidth / (2 * distance);
            const screenY = viewHeight - (y + distance) * viewHeight / (2 * distance);
            
            // Ajustar mida segons altura
            const sizeFactor = 0.5 + 0.5 * Math.sin(altitudeRad);
            const size = element === sun ? 30 + 20 * sizeFactor : 25 + 15 * sizeFactor;
            
            // Aplicar transformacions
            element.style.width = `${size}px`;
            element.style.height = `${size}px`;
            element.style.left = `${screenX}px`;
            element.style.top = `${screenY}px`;
            
            // Amagar si està sota l'horitzó
            element.style.opacity = position.altitude > 0 ? '1' : '0';
        }
        
        // Actualitzar trajectòries
        function updateTrajectories(now, lat, lng) {
            // Netejar trajectòries anteriors
            trajectories.innerHTML = '';
            
            // Generar punts per a la trajectòria del sol
            const sunPoints = [];
            for (let h = 0; h < 24; h += 0.5) {  // Cada 30 minuts
                const time = new Date(now);
                time.setHours(Math.floor(h));
                time.setMinutes((h % 1) * 60);
                
                const pos = calculateSunPosition(time, lat, lng);
                if (pos.altitude > -5) {  // Només si està a prop o sobre l'horitzó
                    sunPoints.push({...pos, time: h});
                }
            }
            
            // Dibuixar trajectòria del sol
            if (sunPoints.length > 1) {
                drawTrajectory(sunPoints, '#FFD700', 'sun-trajectory');
            }
            
            // Generar punts per a la trajectòria de la lluna
            const moonPoints = [];
            for (let h = 0; h < 24; h += 0.5) {  // Cada 30 minuts
                const time = new Date(now);
                time.setHours(Math.floor(h));
                time.setMinutes((h % 1) * 60);
                
                const pos = calculateMoonPosition(time, lat, lng);
                if (pos.altitude > -5) {  // Només si està a prop o sobre l'horitzó
                    moonPoints.push({...pos, time: h});
                }
            }
            
            // Dibuixar trajectòria de la lluna
            if (moonPoints.length > 1) {
                drawTrajectory(moonPoints, '#E6E6FA', 'moon-trajectory');
            }
        }
        
        // Actualitzar marcadors de temps
        function updateTimeMarkers(now, lat, lng) {
            // Eliminar marcadors de temps anteriors
            sunTimeMarkers.forEach(marker => marker.remove());
            moonTimeMarkers.forEach(marker => marker.remove());
            sunTimeMarkers = [];
            moonTimeMarkers = [];
            
            // Crear marcadors de temps per al sol (cada hora)
            for (let h = 0; h < 24; h += 1) {
                const time = new Date(now);
                time.setHours(h);
                time.setMinutes(0);
                
                const pos = calculateSunPosition(time, lat, lng);
                if (pos.altitude > -5) {  // Només si està a prop o sobre l'horitzó
                    const marker = createTimeMarker(pos, h, 'sun-time');
                    sunTimeMarkers.push(marker);
                    document.getElementById('overlay').appendChild(marker);
                }
            }
            
            // Crear marcadors de temps per a la lluna (cada hora)
            for (let h = 0; h < 24; h += 1) {
                const time = new Date(now);
                time.setHours(h);
                time.setMinutes(0);
                
                const pos = calculateMoonPosition(time, lat, lng);
                if (pos.altitude > -5) {  // Només si està a prop o sobre l'horitzó
                    const marker = createTimeMarker(pos, h, 'moon-time');
                    moonTimeMarkers.push(marker);
                    document.getElementById('overlay').appendChild(marker);
                }
            }
        }
        
        // Crear un marcador de temps
        function createTimeMarker(position, hour, className) {
            const viewWidth = window.innerWidth;
            const viewHeight = window.innerHeight;
            
            // Convertir azimut i altura a coordenades de pantalla
            const azimuthRad = (position.azimuth - deviceOrientation.alpha) * Math.PI / 180;
            const altitudeRad = position.altitude * Math.PI / 180;
            
            // Coordenades 3D (simplificat)
            const distance = 100;
            const x = distance * Math.sin(azimuthRad) * Math.cos(altitudeRad);
            const y = distance * Math.sin(altitudeRad);
            
            // Projectar a 2D
            const screenX = (x + distance) * viewWidth / (2 * distance);
            const screenY = viewHeight - (y + distance) * viewHeight / (2 * distance);
            
            // Crear element
            const marker = document.createElement('div');
            marker.className = `time-marker ${className}`;
            marker.textContent = `${hour}h`;
            marker.style.left = `${screenX}px`;
            marker.style.top = `${screenY}px`;
            
            return marker;
        }
        
        // Dibuixar una trajectòria
        function drawTrajectory(points, color, id) {
            const viewWidth = window.innerWidth;
            const viewHeight = window.innerHeight;
            const distance = 100;  // Distància fictícia consistent amb updateCelestialBodyPosition
            
            const pathData = points.map((pos, i) => {
                const azimuthRad = (pos.azimuth - deviceOrientation.alpha) * Math.PI / 180;
                const altitudeRad = pos.altitude * Math.PI / 180;
                
                const x = distance * Math.sin(azimuthRad) * Math.cos(altitudeRad);
                const y = distance * Math.sin(altitudeRad);
                
                const screenX = (x + distance) * viewWidth / (2 * distance);
                const screenY = viewHeight - (y + distance) * viewHeight / (2 * distance);
                
                return `${i === 0 ? 'M' : 'L'}${screenX},${screenY}`;
            }).join(' ');
            
            const path = document.createElementNS('http://www.w3.org/2000/svg', 'path');
            path.setAttribute('d', pathData);
            path.setAttribute('stroke', color);
            path.setAttribute('stroke-width', '2');
            path.setAttribute('fill', 'none');
            path.setAttribute('opacity', '0.7');
            path.setAttribute('id', id);
            
            trajectories.appendChild(path);
        }
        
        // Canviar càmera (frontal/posterior)
        async function switchCamera() {
            currentFacingMode = currentFacingMode === 'environment' ? 'user' : 'environment';
            
            // Aturar el flux actual
            const stream = video.srcObject;
            if (stream) {
                stream.getTracks().forEach(track => track.stop());
            }
            
            // Iniciar amb la nova càmera
            try {
                const newStream = await navigator.mediaDevices.getUserMedia({
                    video: { facingMode: currentFacingMode },
                    audio: false
                });
                video.srcObject = newStream;
            } catch (error) {
                console.error("Error en canviar de càmera:", error);
                alert("No s'ha pogut canviar de càmera: " + error.message);
            }
        }
        
        // Alternar visibilitat de trajectòries
        function toggleTrajectories() {
            showTrajectories = !showTrajectories;
            trajectories.style.display = showTrajectories ? 'block' : 'none';
        }
        
        // Alternar visibilitat de marcadors de temps
        function toggleTimeMarkers() {
            showTimeMarkers = !showTimeMarkers;
            const display = showTimeMarkers ? 'block' : 'none';
            
            sunTimeMarkers.forEach(marker => marker.style.display = display);
            moonTimeMarkers.forEach(marker => marker.style.display = display);
        }
        
        // Càlcul simplificat de la posició del sol
        function calculateSunPosition(date, lat, lng) {
            // Convertir data a hora solar local
            const solarTime = date.getHours() + date.getMinutes() / 60 + (lng / 15);
            
            // Càlcul simplificat de l'angle horari
            const hourAngle = (solarTime - 12) * 15;  // 15 graus per hora
            
            // Declinació solar aproximada (en graus)
            const dayOfYear = getDayOfYear(date);
            const declination = 23.45 * Math.sin((2 * Math.PI / 365) * (dayOfYear - 81));
            
            // Convertir a radians
            const latRad = lat * Math.PI / 180;
            const decRad = declination * Math.PI / 180;
            const hourRad = hourAngle * Math.PI / 180;
            
            // Calcular altura i azimut
            const altitude = Math.asin(
                Math.sin(latRad) * Math.sin(decRad) + 
                Math.cos(latRad) * Math.cos(decRad) * Math.cos(hourRad)
            ) * 180 / Math.PI;
            
            const azimuth = Math.atan2(
                Math.sin(hourRad),
                Math.cos(hourRad) * Math.sin(latRad) - Math.tan(decRad) * Math.cos(latRad)
            ) * 180 / Math.PI + 180;
            
            return { azimuth, altitude };
        }
        
        // Càlcul simplificat de la posició de la lluna
        function calculateMoonPosition(date, lat, lng) {
            // Aproximació molt simplificada
            
            // Fase lunar aproximada (0-29.5 dies)
            const moonPhase = ((date.getTime() / 1000 / 60 / 60 / 24) % 29.53);
            
            // Desplaçament respecte al sol (aprox. 12.2 graus per dia)
            const moonOffset = (moonPhase * 12.2) % 360;
            
            // Obtenir posició solar i afegir desplaçament
            const sunPos = calculateSunPosition(date, lat, lng);
            let moonAzimuth = (sunPos.azimuth + moonOffset + 180) % 360;
            let moonAltitude = sunPos.altitude * 0.9;  // La lluna tendeix a estar més baixa
            
            // Variar l'altura segons la fase
            moonAltitude += (Math.sin(moonPhase * 2 * Math.PI / 29.53) * 10);
            
            return { azimuth: moonAzimuth, altitude: moonAltitude };
        }
        
        // Funció auxiliar per obtenir el dia de l'any
        function getDayOfYear(date) {
            const start = new Date(date.getFullYear(), 0, 0);
            const diff = date - start;
            const oneDay = 1000 * 60 * 60 * 24;
            return Math.floor(diff / oneDay);
        }
    </script>
</body>
</html>