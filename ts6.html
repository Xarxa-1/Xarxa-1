<!DOCTYPE html>
<html lang="ca">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="viewport" content="initial-scale=1.0, width=device-width, user-scalable=yes" />
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="mobile-web-app-capable" content="yes" />
    <meta name="theme-color" content="#002017" />
    <title>TeleStreaming</title>
    <style>
        body, html {
            margin: 0;
            padding: 0;
            font-family: Arial, sans-serif;
            height: 100%;
            display: flex;
            flex-direction: column;
            background-color: black;
        }

        #video-container {
            width: 100vw;
            height: 100vh;
            display: flex;
            background-color: black;
            justify-content: center;
            align-items: center;
        }

        #videoPlayer {
            width: calc(100vw - 30px);
            height: calc(56.25vw + 0px);
            max-height: 98vh;
            max-width: 100%;
            object-fit: cover;
        }

        #controls-container {
            padding: 10px;
            background-color: white;
            display: flex;
            flex-direction: column;
            align-items: center;
            background-color: black;
        }

        #channelSelect {
            margin-bottom: 10px;
            padding: 5px;
            background-color: black;
            color: gold;
            font-size: 16px;
        }

        #channelDetails {
            background-color: black;
            color: white;
            display: flex;
            justify-content: center;
            align-items: center;
            list-style-type: none;
            padding: 0;
            margin: 0;
            overflow-y: auto;
            max-height: 100px;
            width: 100%;
            flex-wrap: wrap;
        }

        #channelDetails li {
            margin: 5px;
            padding: 10px;
            border: 1px solid #ccc;
            display: flex;
            flex-direction: column;
            align-items: center;
            cursor: pointer;
            background: DarkSlateGray;
            height: 70px;
            width: 70px;
            font-size: 11px;
        }

        #channelDetails li.active {
            background-color: #c0c0c0;
        }

        #channelDetails img {
            max-width: 50px;
            margin-bottom: 5px;
        }

        button {
            background-color: gold;
            padding: 10px;
            margin: 5px;
            cursor: pointer;
        }

        button:focus {
            outline: none;
        }

    </style>
</head>
<body>
    <!-- Contenidor del reproductor de vídeo -->
    <div id="video-container">
        <video id="videoPlayer" controls autoplay muted>
            El teu navegador no suporta la reproducció de vídeos en streaming.
        </video>
    </div>

    <!-- Contenidor dels controls i canals -->
    <div id="controls-container">

        <div>
            <center><select id="channelSelect"></select>
                <button id="prevChannel">Canal-</button>
                <button id="nextChannel">Canal+</button>
                <button id="playPause">Play/Pause</button>
                <button id="volumeDown">Volum -</button>
                <button id="volumeUp">Volum +</button>
                <button id="muteUnmute">Mut</button>
                <button id="maximize">Maximitzar</button>
                <button id="minimize" style="display: none;">Minimitzar</button>
                <button id="rewind30">-5min</button>
                <button id="rewind5m">-5s</button>
                <button id="live">Direc</button>
                <button id="forward5s">+5s</button>
                <button id="forward5m">+5min</button>
            </center>
        </div>
        <ul id="channelDetails"></ul>
    </div>

    <!-- Afegim HLS.js -->
    <script src="https://cdn.jsdelivr.net/npm/hls.js@latest"></script>

    <script>
        document.addEventListener('DOMContentLoaded', function () {
            const videoPlayer = document.getElementById('videoPlayer');
            const playPauseBtn = document.getElementById('playPause');
            const prevChannelBtn = document.getElementById('prevChannel');
            const nextChannelBtn = document.getElementById('nextChannel');
            const volumeUpBtn = document.getElementById('volumeUp');
            const volumeDownBtn = document.getElementById('volumeDown');
            const muteUnmuteBtn = document.getElementById('muteUnmute');
            const maximizeBtn = document.getElementById('maximize');
            const minimizeBtn = document.getElementById('minimize');
            const rewind30Btn = document.getElementById('rewind30');
            const rewind5mBtn = document.getElementById('rewind5m');
            const liveBtn = document.getElementById('live');
            const forward5sBtn = document.getElementById('forward5s');
            const forward5mBtn = document.getElementById('forward5m');
            const channelSelect = document.getElementById('channelSelect');
            const channelDetails = document.getElementById('channelDetails');

            let channels = [];
            let currentChannelIndex = 0;

            // URL predeterminada
            const defaultUrl = 'https://directes-tv-cat.ccma.cat/live-origin/tv3-hls/master.m3u8';

            // Funció per carregar els canals des de l'URL
            function loadChannels() {
                fetch('https://raw.githubusercontent.com/Xarxa-1/Xarxa-1/refs/heads/gh-pages/cat18.m3u')
                    .then(response => {
                        if (!response.ok) {
                            throw new Error('No s\'ha pogut carregar el fitxer M3U');
                        }
                        return response.text();
                    })
                    .then(data => {
                        channels = parseM3U(data);
                        if (channels.length > 0) {
                            populateChannelSelect();
                            populateChannelList();
                            playChannel(0); // Començar pel primer canal
                        } else {
                            console.error('No s\'han trobat canals al fitxer M3U');
                        }
                    })
                    .catch(error => {
                        console.error('Error en carregar els canals:', error);
                        playDefaultChannel();  // Reproduir el canal per defecte en cas d'error
                    });
            }

            // Funció per reproduir el canal per defecte
            function playDefaultChannel() {
                playStream(defaultUrl);
            }

            // Funció per analitzar el fitxer M3U
            function parseM3U(data) {
                const lines = data.split('\n');
                const channelList = [];
                let currentChannel = {};

                lines.forEach(line => {
                    if (line.startsWith('#EXTINF')) {
                        const logoMatch = line.match(/tvg-logo="([^"]+)"/);
                        const nameMatch = line.match(/,([^\n]+)/);
                        currentChannel = {
                            name: nameMatch ? nameMatch[1].trim() : '',
                            logo: logoMatch ? logoMatch[1].trim() : ''
                        };
                    } else if (line.startsWith('http')) {
                        currentChannel.url = line.trim();
                        if (currentChannel.name && currentChannel.url) {
                            channelList.push(currentChannel);
                        }
                    }
                });

                return channelList;
            }

            // Funció per omplir el select de canals
            function populateChannelSelect() {
                channels.forEach((channel, index) => {
                    const option = document.createElement('option');
                    option.value = index;
                    option.textContent = channel.name;
                    channelSelect.appendChild(option);
                });
            }

            // Funció per omplir la llista de canals amb detalls
            function populateChannelList() {
                channels.forEach((channel, index) => {
                    const li = document.createElement('li');
                    li.dataset.index = index;

                    const img = document.createElement('img');
                    img.src = channel.logo;
                    li.appendChild(img);

                    const name = document.createElement('span');
                    name.textContent = channel.name;
                    li.appendChild(name);

                    li.addEventListener('click', () => {
                        playChannel(index);
                    });

                    channelDetails.appendChild(li);
                });
            }

            // Funció per reproduir un canal
            function playChannel(index) {
                if (channels.length === 0) return; // Si no hi ha canals, no fer res
                currentChannelIndex = index;
                playStream(channels[index].url);
                updateActiveChannel();
            }

            // Funció per actualitzar el canal actiu
            function updateActiveChannel() {
                document.querySelectorAll('#channelDetails li').forEach(li => {
                    li.classList.remove('active');
                });
                const activeLi = document.querySelector(`#channelDetails li[data-index="${currentChannelIndex}"]`);
                if (activeLi) {
                    activeLi.classList.add('active');
                }
                channelSelect.value = currentChannelIndex;
            }

            // Funció per reproduir un flux amb hls.js
            function playStream(url) {
                if (Hls.isSupported()) {
                    const hls = new Hls();
                    hls.loadSource(url);
                    hls.attachMedia(videoPlayer);
                    hls.on(Hls.Events.MANIFEST_PARSED, function() {
                        videoPlayer.play();
                    });
                } else if (videoPlayer.canPlayType('application/vnd.apple.mpegurl')) {
                    videoPlayer.src = url;
                    videoPlayer.play();
                } else {
                    console.error('El format no és suportat pel navegador.');
                }
            }

            // Controladors dels botons
            playPauseBtn.addEventListener('click', () => {
                if (videoPlayer.paused) {
                    videoPlayer.play();
                } else {
                    videoPlayer.pause();
                }
            });

            prevChannelBtn.addEventListener('click', () => {
                currentChannelIndex = (currentChannelIndex > 0) ? currentChannelIndex - 1 : channels.length - 1;
                playChannel(currentChannelIndex);
            });

            nextChannelBtn.addEventListener('click', () => {
                currentChannelIndex = (currentChannelIndex < channels.length - 1) ? currentChannelIndex + 1 : 0;
                playChannel(currentChannelIndex);
            });

            volumeUpBtn.addEventListener('click', () => {
                videoPlayer.volume = Math.min(videoPlayer.volume + 0.1, 1);
            });

            volumeDownBtn.addEventListener('click', () => {
                videoPlayer.volume = Math.max(videoPlayer.volume - 0.1, 0);
            });

            muteUnmuteBtn.addEventListener('click', () => {
                videoPlayer.muted = !videoPlayer.muted;
            });

            maximizeBtn.addEventListener('click', () => {
                videoPlayer.requestFullscreen();
                maximizeBtn.style.display = 'none';
                minimizeBtn.style.display = 'inline';
            });

            minimizeBtn.addEventListener('click', () => {
                document.exitFullscreen();
                maximizeBtn.style.display = 'inline';
                minimizeBtn.style.display = 'none';
            });

            rewind30Btn.addEventListener('click', () => {
                videoPlayer.currentTime = Math.max(0, videoPlayer.currentTime - 300);
            });

            rewind5mBtn.addEventListener('click', () => {
                videoPlayer.currentTime = Math.max(0, videoPlayer.currentTime - 5);
            });

            liveBtn.addEventListener('click', () => {
                videoPlayer.currentTime = videoPlayer.duration;
            });

            forward5sBtn.addEventListener('click', () => {
                videoPlayer.currentTime = Math.min(videoPlayer.duration, videoPlayer.currentTime + 5);
            });

            forward5mBtn.addEventListener('click', () => {
                videoPlayer.currentTime = Math.min(videoPlayer.duration, videoPlayer.currentTime + 300);
            });

            // Canviar canal amb el select
            channelSelect.addEventListener('change', () => {
                playChannel(parseInt(channelSelect.value));
            });

            // Carregar els canals al carregar la pàgina
            loadChannels();
        });
    </script>
</body>
</html>
